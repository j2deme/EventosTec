<div
  x-data="attendancesAdmin()"
  x-init="init()"
  x-on:open-sync-modal.window="openSyncModal()"
>
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"
  >
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Gestión de Asistencias</h2>
      <p class="mt-1 text-sm text-gray-600">
        Controla asistencias directas (walk-ins) y registros
      </p>
    </div>
    <div class="mt-4 sm:mt-0 inline-flex items-center space-x-3">
      <!-- Botón de sincronización on-demand para actividades relacionadas -->
      <button
        @click="$dispatch('open-sync-modal')"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        <i class="ti ti-repeat mr-2"></i>
        Sincronizar relacionados
      </button>
    </div>
  </div>
  <!-- Búsqueda y filtros compactos -->
  <!-- Search/filter card matching 'Registros' layout -->
  <div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Evento -->
        <div>
          <label
            for="event_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Evento</label
          >
          <select
            id="event_id"
            x-model="filters.event_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los eventos</option>
            <template x-for="e in events" :key="e.id">
              <option
                :value="e.id"
                x-text="e.name || e.title || ('Evento ' + e.id)"
              ></option>
            </template>
          </select>
        </div>

        <!-- Tipo de actividad -->
        <div>
          <label
            for="activity_type"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Tipo de actividad</label
          >
          <select
            id="activity_type"
            x-model="filters.activity_type"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los tipos</option>
            <template x-for="t in activityTypes" :key="t">
              <option :value="t" x-text="t"></option>
            </template>
          </select>
        </div>

        <!-- Actividad -->
        <div>
          <label
            for="activity_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Actividad</label
          >
          <select
            id="activity_id"
            x-model="filters.activity_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todas las actividades</option>
            <template x-for="a in filteredActivities()" :key="a.id">
              <option :value="a.id" x-text="a.name"></option>
            </template>
          </select>
        </div>

        <!-- Estado -->
        <div>
          <label
            for="status"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Estado</label
          >
          <select
            id="status"
            x-model="filters.status_filter"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="all">Todos</option>
            <option value="walkins">Solo walk-ins</option>
            <option value="registered">Solo con registro</option>
          </select>
        </div>

        <!-- Buscar (último) -->
        <div class="md:col-span-1">
          <label
            for="search"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Buscar</label
          >
          <div class="relative rounded-md shadow-sm">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="ti ti-search text-gray-400"></i>
            </div>
            <input
              type="text"
              id="search"
              x-model="filters.search"
              @input.debounce.300ms="refresh()"
              class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 py-2 sm:text-sm border-gray-300 rounded-md"
              placeholder="Número de control, nombre de estudiante, actividad..."
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- stat cards (mejoradas) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-check text-indigo-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Asistencias hoy</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsToday || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-arrow-up-right text-green-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Walk-ins</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsWalkins || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-repeat text-yellow-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">
                Registros convertidos
              </dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsConverted || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- tabla -->
  <div id="attendances-list-container" class="mt-6">
    <div id="search-results" class="mt-0">
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Asistencias</h3>
            <!-- Eliminado buscador y botón: edición por fila individual -->
          </div>

          <div class="overflow-x-auto">
            <!-- Indicador de carga -->
            <div x-show="loading" class="py-8 text-center text-gray-500">
              Cargando asistencias...
            </div>
            <table x-show="!loading" class="min-w-full table-auto text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-3 py-3">
                    <input
                      type="checkbox"
                      x-bind:checked="selectAllForSync"
                      x-on:change="toggleSelectAll($event.target.checked)"
                      aria-label="Seleccionar todas las filas visibles para sincronizar"
                    />
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTUDIANTE
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACTIVIDAD
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTADO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    FECHA REGISTRO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACCIONES
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  x-for="row in attendancesTableFiltered()"
                  :key="row.key"
                >
                  <tr class="border-t hover:bg-gray-50">
                    <td class="px-3 py-2 align-top">
                      <input
                        type="checkbox"
                        x-model="row.__selected_for_sync"
                        aria-label="Seleccionar fila para sincronizar"
                      />
                    </td>
                    <td class="px-6 py-4 align-top">
                      <div
                        class="font-medium text-gray-900"
                        x-text="row.student_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.student_identifier"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <div
                        class="text-gray-900"
                        x-text="row.activity_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.event_name"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <!-- Estado como pill -->
                      <template x-if="row.status === 'present'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'registered'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'error'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="!row.status">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700"
                          x-text="row.statusLabel || '—'"
                        ></span>
                      </template>
                    </td>

                    <td
                      class="px-6 py-4 align-top text-sm text-gray-600"
                      x-text="formatDateAMPM(row.date_display)"
                    ></td>
                    <script>
                      function formatDateAMPM(dateStr) {
                        if (!dateStr) return "";
                        // Try to parse ISO strings robustly
                        let d = new Date(dateStr);
                        if (isNaN(d) && typeof dateStr === "string") {
                          // Fallback: try replacing space with T
                          try {
                            d = new Date(dateStr.replace(" ", "T"));
                          } catch (e) {
                            return dateStr;
                          }
                        }
                        if (isNaN(d)) return dateStr;
                        const pad = (n) => String(n).padStart(2, "0");
                        let hours = d.getHours();
                        const minutes = pad(d.getMinutes());
                        const ampm = hours >= 12 ? "PM" : "AM";
                        hours = hours % 12;
                        hours = hours ? hours : 12;
                        return `${pad(d.getDate())}/${pad(
                          d.getMonth() + 1
                        )}/${d.getFullYear()} ${hours}:${minutes} ${ampm}`;
                      }
                    </script>

                    <td class="px-6 py-4 align-top">
                      <div class="flex items-center space-x-2">
                        <button
                          @click="openEditor(row)"
                          class="text-indigo-600 hover:text-indigo-800 p-2 rounded"
                          title="Editar"
                        >
                          <i class="ti ti-pencil"></i>
                        </button>

                        <button
                          @click="row.registration_id ? goToRegistration(row) : (window.showToast ? window.showToast('No hay registro asociado','warning') : alert('No hay registro asociado'))"
                          :class="row.registration_id ? 'text-gray-600 hover:text-gray-800' : 'text-gray-400 cursor-not-allowed opacity-60'"
                          class="p-2 rounded"
                          :title="row.registration_id ? 'Ver registro' : 'Sin registro'"
                        >
                          <i class="ti ti-book"></i>
                        </button>

                        <button
                          @click="deleteAttendance(row)"
                          class="text-red-600 hover:text-red-800 p-2 rounded"
                          title="Eliminar"
                        >
                          <i class="ti ti-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr
                  x-show="!loading && attendancesTableFiltered().length === 0"
                >
                  <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    No se encontraron registros
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- contenedor oculto para el modal/assign (compatibilidad con dispatch) -->
      <div
        id="attendances-assign-container"
        x-cloak
        style="display: none"
      ></div>
    </div>

    <!-- Modal simple para registrar -->
    <div
      x-show="showModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Registrar asistencia</h3>
        <div class="mb-3">
          <label class="block text-sm">Estudiante ID</label>
          <input
            x-model="modalStudentId"
            id="modal-student-id"
            class="mt-1 block w-full rounded border-gray-300"
          />
        </div>
        <div class="mb-3">
          <label class="block text-sm">Actividad ID</label>
          <input
            x-model="modalActivityId"
            id="modal-activity-id"
            class="mt-1 block w-full rounded border-gray-300"
          />
        </div>
        <div class="mb-3">
          <label class="inline-flex items-center">
            <input
              x-model="modalMarkPresent"
              id="modal-mark-present"
              type="checkbox"
              class="form-checkbox"
            />
            <span class="ml-2">Marcar como presente (100%)</span>
          </label>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="closeModal()" class="px-3 py-2 bg-gray-200 rounded">
            Cancelar
          </button>
          <button
            @click="submitModal()"
            class="px-3 py-2 bg-indigo-600 text-white rounded"
          >
            Registrar
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para ver registro asociado -->
    <div
      x-show="showRegistrationModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeRegistrationModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Registro asociado</h3>
          <button
            @click="closeRegistrationModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            ✕
          </button>
        </div>

        <template>
          <div class="grid grid-cols-1 gap-3" x-show="registrationModalData">
            <div class="flex items-start justify-between">
              <div>
                <div class="text-sm text-gray-500">Estudiante</div>
                <div
                  class="font-semibold text-gray-900 text-lg"
                  x-text="registrationModalData.student?.full_name || registrationModalData.student_name || ('ID ' + (registrationModalData.student_id || '-'))"
                ></div>
                <div class="text-xs text-gray-600 mt-1">
                  <span
                    x-text="registrationModalData.student?.control_number ? ('No. control: ' + registrationModalData.student?.control_number) : ''"
                  ></span>
                </div>
              </div>
              <div class="text-right text-sm text-gray-600">
                <div x-show="registrationModalData.student?.email">
                  <div class="text-xs text-gray-500">Email</div>
                  <div
                    x-text="registrationModalData.student?.email || ''"
                  ></div>
                </div>
                <div x-show="registrationModalData.student?.phone" class="mt-2">
                  <div class="text-xs text-gray-500">Tel.</div>
                  <div
                    x-text="registrationModalData.student?.phone || ''"
                  ></div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-2">
              <div>
                <div class="text-xs text-gray-500">Actividad</div>
                <div
                  class="font-medium text-gray-800"
                  x-text="registrationModalData.activity?.name || registrationModalData.activity_name || ('ID ' + (registrationModalData.activity_id || '-'))"
                ></div>
                <div
                  class="text-xs text-gray-600 mt-1"
                  x-text="registrationModalData.event_name || registrationModalData.activity?.event?.name || ''"
                ></div>
              </div>
              <div>
                <div class="text-xs text-gray-500">Estado</div>
                <div
                  class="font-medium"
                  x-text="registrationModalData.status || registrationModalData.registration_status || '-' "
                ></div>
                <div class="text-xs text-gray-500 mt-2">Fecha registro</div>
                <div
                  class="text-sm text-gray-700"
                  x-text="registrationModalData.created_at || registrationModalData.registered_at || registrationModalData.date ? formatDateAMPM(registrationModalData.created_at || registrationModalData.registered_at || registrationModalData.date) : '-' "
                ></div>
              </div>
            </div>

            <div class="flex items-center justify-end mt-4">
              <button
                @click="closeRegistrationModal()"
                class="px-3 py-2 bg-gray-200 rounded text-sm"
              >
                Cerrar
              </button>
            </div>
          </div>
        </template>

        <template x-if="!registrationModalData">
          <div class="text-gray-600">
            No hay información de registro disponible.
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Modal para sincronizar actividades relacionadas -->
  <div
    x-show="showSyncModal"
    x-cloak
    style="display: none"
    class="fixed inset-0 z-50 flex items-center justify-center"
  >
    <div
      class="bg-black bg-opacity-50 absolute inset-0"
      @click="closeSyncModal()"
    ></div>
    <div class="bg-white rounded p-6 z-10 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">
        Sincronizar actividades relacionadas
      </h3>
      <div class="mb-3">
        <label class="block text-sm">Actividad fuente</label>
        <select
          x-model="syncSourceActivityId"
          class="mt-1 block w-full rounded border-gray-300"
        >
          <option value="">-- Selecciona una actividad --</option>
          <template x-for="a in activities" :key="a.id">
            <option
              :value="a.id"
              x-text="(a.name || ('Actividad ' + a.id)) + (a.event_name ? (' — ' + a.event_name) : '')"
            ></option>
          </template>
        </select>
      </div>
      <div class="mb-3">
        <label class="inline-flex items-center">
          <input type="checkbox" x-model="syncDryRun" class="form-checkbox" />
          <span class="ml-2"
            >Dry run (previsualización, no se guardan cambios)</span
          >
        </label>
      </div>

      <div class="text-sm text-gray-700 mb-3">
        <template x-if="selectedForSyncCount() > 0">
          <div>
            Seleccionados: <strong x-text="selectedForSyncCount()"></strong> de
            <span x-text="visibleForSyncCount()"></span> filas visibles. Estos
            serán enviados al servidor.
          </div>
        </template>
        <template x-if="selectedForSyncCount() === 0">
          <div>
            No hay filas seleccionadas — se sincronizarán todos los estudiantes
            presentes en la actividad fuente (si no se especifican filas).
          </div>
        </template>
      </div>

      <div class="flex justify-end space-x-2">
        <button
          @click="closeSyncModal()"
          class="px-3 py-2 bg-gray-200 rounded"
          :disabled="syncRunning"
        >
          Cancelar
        </button>
        <button
          @click="performSync()"
          class="px-3 py-2 bg-indigo-600 text-white rounded flex items-center"
          :disabled="syncRunning"
        >
          <svg
            x-show="syncRunning"
            class="animate-spin -ml-1 mr-2 h-5 w-5 text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
            ></path>
          </svg>
          <span x-text="syncRunning ? 'Sincronizando...' : 'Ejecutar'"></span>
        </button>
      </div>

      <template x-if="syncResult">
        <div class="mt-4">
          <div class="text-sm font-medium">Resumen</div>
          <div class="text-xs text-gray-600">
            Creados: <span x-text="syncResult.created || 0"></span>, Saltados:
            <span x-text="syncResult.skipped || 0"></span>
          </div>
          <div class="mt-2 max-h-48 overflow-auto text-xs text-gray-700">
            <template
              x-for="d in (syncResult.details || [])"
              :key="d.student_id + '-' + d.target_activity_id"
            >
              <div class="py-1 border-b">
                ID estudiante: <span x-text="d.student_id"></span> → Actividad:
                <span x-text="d.target_activity_id"></span> —
                <span x-text="d.action"></span> (<span x-text="d.reason"></span
                >)
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
</div>
