<div
  x-data="attendancesAdmin()"
  x-init="init()"
  x-on:open-sync-modal.window="openSyncModal()"
>
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"
  >
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Gestión de Asistencias</h2>
      <p class="mt-1 text-sm text-gray-600">
        Controla asistencias directas (walk-ins) y registros
      </p>
    </div>
    <div class="mt-4 sm:mt-0 inline-flex items-center space-x-3">
      <!-- Botón para registrar walk-in con buscador por número de control -->
      <button
        @click="openRegister()"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
      >
        <i class="ti ti-user-plus mr-2"></i>
        Registrar walk-in
      </button>
      <!-- Botón para subida batch de asistencias -->
      <button
        @click="openBatchUploadModal()"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <i class="ti ti-upload mr-2"></i>
        Subida batch
      </button>
      <!-- Botón para ejecutar batch-checkout (recalcular/check-out en lote) -->
      <button
        @click="openBatchCheckoutModal()"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500"
      >
        <i class="ti ti-clock mr-2"></i>
        Batch checkout
      </button>
      <!-- Botón de sincronización on-demand para actividades relacionadas -->
      <button
        @click="$dispatch('open-sync-modal')"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        <i class="ti ti-repeat mr-2"></i>
        Sincronizar relacionados
      </button>
    </div>
  </div>

  <!-- Modal para batch-checkout (recalcular y checkout emulado) -->
  <div
    x-show="showBatchCheckoutModal"
    x-cloak
    style="display: none"
    class="fixed inset-0 z-50 flex items-center justify-center"
  >
    <div
      class="bg-black bg-opacity-50 absolute inset-0"
      @click="closeBatchCheckoutModal()"
    ></div>
    <div class="bg-white rounded p-6 z-10 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">Batch checkout</h3>

      <div class="mb-3">
        <label class="block text-sm">Evento</label>
        <select
          x-model="batchEventId"
          @change="batchActivityId = null"
          class="mt-1 block w-full rounded border-gray-300"
        >
          <option value="">-- Selecciona un evento --</option>
          <template x-for="e in events" :key="e.id">
            <option
              :value="e.id"
              x-text="e.name || e.title || ('Evento ' + e.id)"
            ></option>
          </template>
        </select>
      </div>

      <div class="mb-3">
        <label class="block text-sm">Actividad</label>
        <select
          x-model="batchActivityId"
          class="mt-1 block w-full rounded border-gray-300"
        >
          <option value="">-- Selecciona una actividad --</option>
          <template x-for="a in batchFilteredActivities()" :key="a.id">
            <option
              :value="a.id"
              x-text="(a.name || ('Actividad ' + a.id)) + (a.event_name ? (' — ' + a.event_name) : '')"
            ></option>
          </template>
        </select>
      </div>

      <div class="mb-3">
        <label class="inline-flex items-center">
          <input type="checkbox" x-model="batchDryRun" class="form-checkbox" />
          <span class="ml-2"
            >Dry run (previsualización, no se guardan cambios)</span
          >
        </label>
      </div>

      <div class="flex justify-end space-x-2">
        <button
          @click="closeBatchCheckoutModal()"
          class="px-3 py-2 bg-gray-200 rounded"
        >
          Cancelar
        </button>
        <button
          @click="performBatchCheckout()"
          class="px-3 py-2 bg-yellow-600 text-white rounded"
        >
          Ejecutar
        </button>
      </div>

      <template x-if="batchResult">
        <div class="mt-4">
          <div class="text-sm font-medium">Resumen</div>
          <div class="text-xs text-gray-600">
            Procesados: <span x-text="batchResult.processed || 0"></span>,
            Actualizados: <span x-text="batchResult.updated || 0"></span>,
            Relacionadas creadas:
            <span x-text="batchResult.related_created || 0"></span>
          </div>
          <div class="mt-2 max-h-48 overflow-auto text-xs text-gray-700">
            <template
              x-for="d in (batchResult.details || [])"
              :key="d.attendance_id"
            >
              <div class="py-1 border-b">
                Asistencia ID: <span x-text="d.attendance_id"></span> —
                Porcentaje: <span x-text="d.percentage || 0"></span> — Related
                created: <span x-text="d.related_created || 0"></span>
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>
  <!-- Búsqueda y filtros compactos -->
  <!-- Search/filter card matching 'Registros' layout -->
  <div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <!-- Evento -->
        <div>
          <label
            for="event_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Evento</label
          >
          <select
            id="event_id"
            x-model="filters.event_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los eventos</option>
            <template x-for="e in events" :key="e.id">
              <option
                :value="e.id"
                x-text="e.name || e.title || ('Evento ' + e.id)"
              ></option>
            </template>
          </select>
        </div>

        <!-- Tipo de actividad -->
        <div>
          <label
            for="activity_type"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Tipo de actividad</label
          >
          <select
            id="activity_type"
            x-model="filters.activity_type"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los tipos</option>
            <template x-for="t in activityTypes" :key="t">
              <option :value="t" x-text="t"></option>
            </template>
          </select>
        </div>

        <!-- Actividad -->
        <div>
          <label
            for="activity_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Actividad</label
          >
          <select
            id="activity_id"
            x-model="filters.activity_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todas las actividades</option>
            <template x-for="a in filteredActivities()" :key="a.id">
              <option :value="a.id" x-text="a.name"></option>
            </template>
          </select>
        </div>

        <!-- Estado -->
        <div>
          <label
            for="status"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Estado</label
          >
          <select
            id="status"
            x-model="filters.status_filter"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="all">Todos</option>
            <option value="walkins">Solo walk-ins</option>
            <option value="registered">Solo con registro</option>
          </select>
        </div>

        <!-- Buscar (último) -->
        <div class="md:col-span-1">
          <label
            for="search"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Buscar</label
          >
          <div class="relative rounded-md shadow-sm">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="ti ti-search text-gray-400"></i>
            </div>
            <input
              type="text"
              id="search"
              x-model="filters.search"
              @input.debounce.300ms="refresh()"
              class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 py-2 sm:text-sm border-gray-300 rounded-md"
              placeholder="Número de control, nombre de estudiante, actividad..."
            />
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- stat cards (mejoradas) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-6">
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-check text-indigo-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Asistencias hoy</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsToday || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-arrow-up-right text-green-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Walk-ins</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsWalkins || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-repeat text-yellow-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">
                Registros convertidos
              </dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsConverted || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- tabla -->
  <div id="attendances-list-container" class="mt-6">
    <div id="search-results" class="mt-0">
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Asistencias</h3>
            <!-- Eliminado buscador y botón: edición por fila individual -->
          </div>

          <div class="overflow-x-auto">
            <!-- Indicador de carga -->
            <div x-show="loading" class="py-8 text-center text-gray-500">
              Cargando asistencias...
            </div>
            <table x-show="!loading" class="min-w-full table-auto text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th class="px-3 py-3">
                    <input
                      type="checkbox"
                      x-bind:checked="selectAllForSync"
                      x-on:change="toggleSelectAll($event.target.checked)"
                      aria-label="Seleccionar todas las filas visibles para sincronizar"
                    />
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTUDIANTE
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACTIVIDAD
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTADO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    FECHA REGISTRO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACCIONES
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  x-for="row in attendancesTableFiltered()"
                  :key="row.key"
                >
                  <tr class="border-t hover:bg-gray-50">
                    <td class="px-3 py-2 align-top">
                      <input
                        type="checkbox"
                        x-model="row.__selected_for_sync"
                        aria-label="Seleccionar fila para sincronizar"
                      />
                    </td>
                    <td class="px-6 py-4 align-top">
                      <div
                        class="font-medium text-gray-900"
                        x-text="row.student_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.student_identifier"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <div
                        class="text-gray-900"
                        x-text="row.activity_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.event_name"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <!-- Estado como pill -->
                      <template x-if="row.status === 'present'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'registered'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'error'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="!row.status">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700"
                          x-text="row.statusLabel || '—'"
                        ></span>
                      </template>
                    </td>

                    <td
                      class="px-6 py-4 align-top text-sm text-gray-600"
                      x-text="formatDateAMPM(row.date_display)"
                    ></td>
                    <script>
                      function formatDateAMPM(dateStr) {
                        if (!dateStr) return "";
                        // Try to parse ISO strings robustly
                        let d = new Date(dateStr);
                        if (isNaN(d) && typeof dateStr === "string") {
                          // Fallback: try replacing space with T
                          try {
                            d = new Date(dateStr.replace(" ", "T"));
                          } catch (e) {
                            return dateStr;
                          }
                        }
                        if (isNaN(d)) return dateStr;
                        const pad = (n) => String(n).padStart(2, "0");
                        let hours = d.getHours();
                        const minutes = pad(d.getMinutes());
                        const ampm = hours >= 12 ? "PM" : "AM";
                        hours = hours % 12;
                        hours = hours ? hours : 12;
                        return `${pad(d.getDate())}/${pad(
                          d.getMonth() + 1
                        )}/${d.getFullYear()} ${hours}:${minutes} ${ampm}`;
                      }
                    </script>

                    <td class="px-6 py-4 align-top">
                      <div class="flex items-center space-x-2">
                        <button
                          @click="openEditor(row)"
                          class="text-indigo-600 hover:text-indigo-800 p-2 rounded"
                          title="Editar"
                        >
                          <i class="ti ti-pencil"></i>
                        </button>

                        <button
                          @click="row.registration_id ? goToRegistration(row) : (window.showToast ? window.showToast('No hay registro asociado','warning') : alert('No hay registro asociado'))"
                          :class="row.registration_id ? 'text-gray-600 hover:text-gray-800' : 'text-gray-400 cursor-not-allowed opacity-60'"
                          class="p-2 rounded"
                          :title="row.registration_id ? 'Ver registro' : 'Sin registro'"
                        >
                          <i class="ti ti-book"></i>
                        </button>

                        <!-- Pause/Resume buttons for Magistral activities -->
                        <template
                          x-if="row.activity_type === 'Magistral' && row.check_in_time && !row.check_out_time"
                        >
                          <button
                            x-show="!row.is_paused"
                            @click="pauseAttendance(row)"
                            class="text-orange-600 hover:text-orange-800 p-2 rounded"
                            title="Pausar asistencia"
                          >
                            <i class="ti ti-player-pause"></i>
                          </button>
                        </template>
                        <template
                          x-if="row.activity_type === 'Magistral' && row.is_paused"
                        >
                          <button
                            @click="resumeAttendance(row)"
                            class="text-green-600 hover:text-green-800 p-2 rounded"
                            title="Reanudar asistencia"
                          >
                            <i class="ti ti-player-play"></i>
                          </button>
                        </template>

                        <button
                          @click="deleteAttendance(row)"
                          class="text-red-600 hover:text-red-800 p-2 rounded"
                          title="Eliminar"
                        >
                          <i class="ti ti-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr
                  x-show="!loading && attendancesTableFiltered().length === 0"
                >
                  <td colspan="6" class="px-6 py-8 text-center text-gray-500">
                    No se encontraron registros
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- contenedor oculto para el modal/assign (compatibilidad con dispatch) -->
      <div
        id="attendances-assign-container"
        x-cloak
        style="display: none"
      ></div>
    </div>

    <!-- Modal simple para registrar -->
    <div
      x-show="showModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-lg">
        <h3 class="text-lg font-semibold mb-4">Registrar Walk-in</h3>

        <div class="grid grid-cols-1 gap-3 mb-3">
          <div>
            <label class="block text-sm">Evento</label>
            <select
              x-model="selectedEventForRegister"
              class="mt-1 block w-full rounded border-gray-300"
              @change="loadActivities()"
              required
            >
              <option value="">-- Selecciona evento --</option>
              <template
                x-for="e in events.filter(ev => ev.is_active)"
                :key="e.id"
              >
                <option
                  :value="e.id"
                  x-text="e.name || e.title || ('Evento ' + e.id)"
                ></option>
              </template>
            </select>
          </div>

          <div>
            <label class="block text-sm">Actividad</label>
            <select
              x-model="selectedActivity"
              class="mt-1 block w-full rounded border-gray-300"
              @change="checkExistingRegistration()"
            >
              <option value="">-- Selecciona actividad --</option>
              <template
                x-for="a in activities.filter(ac=> !selectedEventForRegister || String(ac.event_id)===String(selectedEventForRegister))"
                :key="a.id"
              >
                <option
                  :value="a.id"
                  x-text="a.name + (a.event_name ? (' — ' + a.event_name) : '')"
                ></option>
              </template>
            </select>
          </div>

          <div>
            <label class="block text-sm"
              >Buscar estudiante (número de control)</label
            >
            <input
              x-model="studentSearchQuery"
              @input.debounce.300ms="doStudentSearch()"
              placeholder="Ej: 20123456"
              class="mt-1 block w-full rounded border-gray-300"
            />
            <div class="mt-2 max-h-40 overflow-auto bg-gray-50 rounded">
              <template x-for="s in studentSearchResults" :key="s.id">
                <div
                  class="p-2 hover:bg-gray-100 cursor-pointer flex items-center justify-between"
                  @click="selectedStudent = s; checkExistingRegistration()"
                >
                  <div>
                    <div class="font-medium" x-text="s.full_name"></div>
                    <div
                      class="text-xs text-gray-600"
                      x-text="s.control_number"
                    ></div>
                  </div>
                  <div>
                    <template
                      x-if="selectedStudent && selectedStudent.id === s.id"
                    >
                      <span class="text-sm text-green-600">Seleccionado</span>
                    </template>
                  </div>
                </div>
              </template>
              <template
                x-if="studentSearchResults.length === 0 && studentSearchQuery"
              >
                <div class="p-2 text-sm text-gray-500">
                  No se encontraron estudiantes
                </div>
              </template>
            </div>
            <!-- Si existe un preregistro para student+activity, mostrar info y acción rápida -->
            <template x-if="selectedRegistration">
              <div
                class="mt-3 p-3 bg-yellow-50 border border-yellow-200 rounded"
              >
                <div class="flex items-start justify-between">
                  <div>
                    <div class="text-sm font-medium text-yellow-800">
                      Pre-registro encontrado
                    </div>
                    <div
                      class="text-xs text-gray-700 mt-1"
                      x-text="selectedRegistration.student?.full_name || selectedRegistration.student_name || ''"
                    ></div>
                    <div class="text-xs text-gray-500 mt-1">
                      Estado:
                      <span
                        x-text="selectedRegistration.status || selectedRegistration.registration_status || ''"
                      ></span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">
                      ID registro:
                      <span
                        x-text="selectedRegistration.id || selectedRegistration.registration_id || '-' "
                      ></span>
                    </div>
                  </div>
                  <div class="flex flex-col items-end space-y-2">
                    <button
                      @click="modalMarkPresent = true; submitAssign()"
                      class="px-3 py-1 bg-indigo-600 text-white rounded text-sm"
                    >
                      Marcar como Asistió
                    </button>
                    <button
                      @click="openRegistrationModal(selectedRegistration)"
                      class="px-3 py-1 bg-white border rounded text-sm text-gray-700"
                    >
                      Ver registro
                    </button>
                  </div>
                </div>
              </div>
            </template>
          </div>
        </div>

        <div class="flex items-center justify-end space-x-2">
          <button @click="closeModal()" class="px-3 py-2 bg-gray-200 rounded">
            Cancelar
          </button>
          <button
            @click="submitAssign()"
            class="px-3 py-2 bg-green-600 text-white rounded"
            :disabled="!selectedEventForRegister || !selectedActivity || !selectedStudent"
          >
            Registrar Walk-in
          </button>
        </div>
      </div>
    </div>

    <!-- Modal para ver registro asociado -->
    <div
      x-show="showRegistrationModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeRegistrationModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Registro asociado</h3>
          <button
            @click="closeRegistrationModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            ✕
          </button>
        </div>

        <!-- Static placeholders for debugging: remove Alpine bindings to ensure modal displays content -->
        <div class="grid grid-cols-1 gap-3">
          <div class="flex items-start justify-between">
            <div>
              <div class="text-sm text-gray-500">Estudiante</div>
              <div
                class="font-semibold text-gray-900 text-lg"
                x-text="registrationModalData?.student_name || (registrationModalData?.student && registrationModalData.student.full_name) || '—'"
              ></div>
              <div class="text-xs text-gray-600 mt-1">
                No. control:
                <span
                  x-text="registrationModalData?.student_identifier || (registrationModalData?.student && registrationModalData.student.control_number) || '—'"
                ></span>
              </div>
            </div>
            <div class="text-right text-sm text-gray-600">
              <div class="text-xs text-gray-500">Email</div>
              <div
                x-text="registrationModalData?.email || (registrationModalData?.student && registrationModalData.student.email) || '—'"
              ></div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4 mt-2">
            <div>
              <div class="text-xs text-gray-500">Actividad</div>
              <div
                class="font-medium text-gray-800"
                x-text="registrationModalData?.activity_name || (registrationModalData?.activity && registrationModalData.activity.name) || '—'"
              ></div>
              <div
                class="text-xs text-gray-600 mt-1"
                x-text="registrationModalData?.event_name || (registrationModalData?.activity && registrationModalData.activity.event && registrationModalData.activity.event.name) || '—'"
              ></div>
            </div>
            <div>
              <div class="text-xs text-gray-500">Estado</div>
              <div
                class="font-medium"
                x-text="registrationModalData?.status || (registrationModalData?.registration && registrationModalData.registration.status) || '—'"
              ></div>
              <div class="text-xs text-gray-500 mt-2">Fecha registro</div>
              <div
                class="text-sm text-gray-700"
                x-text="formatDateAMPM(registrationModalData?.registration_date || registrationModalData?.created_at || (registrationModalData?.registration && registrationModalData.registration.registration_date)) || '—'"
              ></div>
              <div
                x-show="(registrationModalData && (registrationModalData.confirmation_date || (registrationModalData.registration && registrationModalData.registration.confirmation_date)))"
                x-cloak
              >
                <div class="text-xs text-gray-500 mt-2">Fecha confirmación</div>
                <div
                  class="text-sm text-gray-700"
                  x-text="formatDateAMPM(registrationModalData?.confirmation_date || (registrationModalData?.registration && registrationModalData.registration.confirmation_date)) || '—'"
                ></div>
              </div>
            </div>
          </div>

          <div class="flex items-center justify-end mt-4">
            <button
              @click="closeRegistrationModal()"
              class="px-3 py-2 bg-gray-200 rounded text-sm"
            >
              Cerrar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para editar asistencia (dedicado) -->
    <div
      x-show="showEditAttendanceModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeEditModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Editar asistencia</h3>
          <button
            @click="closeEditModal()"
            class="text-gray-500 hover:text-gray-700"
          >
            ✕
          </button>
        </div>

        <div class="grid grid-cols-1 gap-3 mb-3">
          <div>
            <label class="block text-sm text-gray-600">Estudiante</label>
            <div
              class="mt-1 text-sm font-medium text-gray-900"
              x-text="editAttendanceData?.student_name || '—'"
            ></div>
            <div
              class="text-xs text-gray-500"
              x-text="editAttendanceData?.student_identifier || ''"
            ></div>
          </div>

          <div>
            <label class="block text-sm text-gray-600">Actividad</label>
            <div
              class="mt-1 text-sm font-medium text-gray-900"
              x-text="editAttendanceData?.activity_name || editAttendanceData?.event_name || '—'"
            ></div>
          </div>

          <div>
            <label class="block text-sm">Check-in</label>
            <input
              type="text"
              x-model="editAttendanceData.check_in_time"
              placeholder="YYYY-MM-DD HH:MM"
              class="mt-1 block w-full rounded border-gray-300"
            />
          </div>

          <div>
            <label class="block text-sm">Check-out</label>
            <input
              type="text"
              x-model="editAttendanceData.check_out_time"
              placeholder="YYYY-MM-DD HH:MM"
              class="mt-1 block w-full rounded border-gray-300"
            />
          </div>

          <div class="flex items-center">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                x-model="editAttendanceData.mark_present"
                class="form-checkbox"
              />
              <span class="ml-2">Marcar como presente</span>
            </label>
          </div>

          <div>
            <label class="block text-sm">Notas</label>
            <textarea
              x-model="editAttendanceData.notes"
              class="mt-1 block w-full rounded border-gray-300"
              rows="3"
            ></textarea>
          </div>

          <template
            x-if="editAttendanceData && editAttendanceData.registration_id"
          >
            <div class="text-sm text-gray-600">
              Registro asociado:
              <button
                class="text-indigo-600 underline ml-2"
                @click="openRegistrationModal(editAttendanceData.registration_id)"
              >
                Ver registro
              </button>
            </div>
          </template>
        </div>

        <div class="flex items-center justify-end space-x-2">
          <button
            @click="closeEditModal()"
            class="px-3 py-2 bg-gray-200 rounded"
          >
            Cancelar
          </button>
          <button
            @click.prevent="submitEdit()"
            :disabled="editSubmitting"
            class="px-3 py-2 bg-indigo-600 text-white rounded"
            :class="{ 'opacity-60 cursor-not-allowed': editSubmitting }"
          >
            <span x-show="!editSubmitting">Guardar</span>
            <span x-show="editSubmitting">Guardando…</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal para sincronizar actividades relacionadas -->
  <div
    x-show="showSyncModal"
    x-cloak
    style="display: none"
    class="fixed inset-0 z-50 flex items-center justify-center"
  >
    <div
      class="bg-black bg-opacity-50 absolute inset-0"
      @click="closeSyncModal()"
    ></div>
    <div class="bg-white rounded p-6 z-10 w-full max-w-md">
      <h3 class="text-lg font-semibold mb-4">
        Sincronizar actividades relacionadas
      </h3>
      <div class="mb-3">
        <label class="block text-sm">Actividad fuente</label>
        <select
          x-model="syncSourceActivityId"
          class="mt-1 block w-full rounded border-gray-300"
        >
          <option value="">-- Selecciona una actividad --</option>
          <template x-for="a in activities" :key="a.id">
            <option
              :value="a.id"
              x-text="(a.name || ('Actividad ' + a.id)) + (a.event_name ? (' — ' + a.event_name) : '')"
            ></option>
          </template>
        </select>
      </div>
      <div class="mb-3">
        <label class="inline-flex items-center">
          <input type="checkbox" x-model="syncDryRun" class="form-checkbox" />
          <span class="ml-2"
            >Dry run (previsualización, no se guardan cambios)</span
          >
        </label>
      </div>

      <div class="text-sm text-gray-700 mb-3">
        <template x-if="selectedForSyncCount() > 0">
          <div>
            Seleccionados: <strong x-text="selectedForSyncCount()"></strong> de
            <span x-text="visibleForSyncCount()"></span> filas visibles. Estos
            serán enviados al servidor.
          </div>
        </template>
        <template x-if="selectedForSyncCount() === 0">
          <div>
            No hay filas seleccionadas — se sincronizarán todos los estudiantes
            presentes en la actividad fuente (si no se especifican filas).
          </div>
        </template>
      </div>

      <div class="flex justify-end space-x-2">
        <button
          @click="closeSyncModal()"
          class="px-3 py-2 bg-gray-200 rounded"
          :disabled="syncRunning"
        >
          Cancelar
        </button>
        <button
          @click="performSync()"
          class="px-3 py-2 bg-indigo-600 text-white rounded flex items-center"
          :disabled="syncRunning"
        >
          <svg
            x-show="syncRunning"
            class="animate-spin -ml-1 mr-2 h-5 w-5 text-white"
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
          >
            <circle
              class="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              stroke-width="4"
            ></circle>
            <path
              class="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
            ></path>
          </svg>
          <span x-text="syncRunning ? 'Sincronizando...' : 'Ejecutar'"></span>
        </button>
      </div>

      <template x-if="syncResult">
        <div class="mt-4">
          <div class="text-sm font-medium">Resumen</div>
          <div class="text-xs text-gray-600">
            Creados: <span x-text="syncResult.created || 0"></span>, Saltados:
            <span x-text="syncResult.skipped || 0"></span>
          </div>
          <div class="mt-2 max-h-48 overflow-auto text-xs text-gray-700">
            <template
              x-for="d in (syncResult.details || [])"
              :key="d.student_id + '-' + d.target_activity_id"
            >
              <div class="py-1 border-b">
                ID estudiante: <span x-text="d.student_id"></span> → Actividad:
                <span x-text="d.target_activity_id"></span> —
                <span x-text="d.action"></span> (<span x-text="d.reason"></span
                >)
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Modal: Subida batch de asistencias -->
  <div
    x-show="showBatchUploadModal"
    x-cloak
    class="fixed inset-0 z-50 overflow-y-auto"
    aria-labelledby="batch-upload-modal-title"
    role="dialog"
    aria-modal="true"
  >
    <div
      class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0"
    >
      <div
        x-show="showBatchUploadModal"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100"
        x-transition:leave-end="opacity-0"
        class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        @click="closeBatchUploadModal()"
      ></div>

      <span
        class="hidden sm:inline-block sm:align-middle sm:h-screen"
        aria-hidden="true"
        >&#8203;</span
      >

      <div
        x-show="showBatchUploadModal"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="inline-block align-bottom bg-white rounded-lg px-4 pt-5 pb-4 text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl sm:w-full sm:p-6"
      >
        <div class="sm:flex sm:items-start">
          <div
            class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 sm:mx-0 sm:h-10 sm:w-10"
          >
            <i class="ti ti-upload text-blue-600"></i>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3
              class="text-lg leading-6 font-medium text-gray-900"
              id="batch-upload-modal-title"
            >
              Subida batch de asistencias
            </h3>
            <div class="mt-2 text-sm text-gray-500">
              Selecciona un evento, departamento, actividad y un archivo TXT o
              XLSX con números de control. Puedes marcar "Dry run" para validar
              sin guardar.
            </div>

            <!-- Pestañas para alternar vista -->
            <div class="flex items-center gap-2 mb-3 mt-2">
              <button
                type="button"
                @click.prevent="batchUploadView = 'file'"
                :class="{ 'bg-indigo-100 text-indigo-700': batchUploadView === 'file' }"
                class="px-3 py-1 rounded text-sm"
              >
                Archivo
              </button>
              <button
                type="button"
                @click.prevent="batchUploadView = 'report'"
                :class="{ 'bg-indigo-100 text-indigo-700': batchUploadView === 'report' }"
                class="px-3 py-1 rounded text-sm"
                :disabled="!batchUploadReport"
              >
                Resultado
              </button>
            </div>

            <!-- Vista Archivo -->
            <div x-show="batchUploadView === 'file'" x-cloak>
              <div class="space-y-3">
                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Evento</label
                  >
                  <select
                    x-model="batchUploadEventId"
                    @change="batchUploadDepartment = ''; batchUploadActivityId = null"
                    class="mt-1 block w-full rounded border-gray-300"
                  >
                    <option value="">-- Selecciona un evento --</option>
                    <template x-for="ev in events" :key="ev.id">
                      <option :value="ev.id" x-text="ev.name"></option>
                    </template>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Departamento</label
                  >
                  <select
                    x-model="batchUploadDepartment"
                    @change="batchUploadActivityId = null"
                    class="mt-1 block w-full rounded border-gray-300"
                  >
                    <option value="">-- Selecciona un departamento --</option>
                    <template
                      x-for="dept in batchUploadFilteredDepartments()"
                      :key="dept"
                    >
                      <option :value="dept" x-text="dept"></option>
                    </template>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Actividad</label
                  >
                  <select
                    x-model="batchUploadActivityId"
                    class="mt-1 block w-full rounded border-gray-300"
                  >
                    <option value="">-- Selecciona una actividad --</option>
                    <template
                      x-for="a in batchUploadFilteredActivities()"
                      :key="a.id"
                    >
                      <option
                        :value="a.id"
                        x-text="a.name || ('Actividad ' + a.id)"
                      ></option>
                    </template>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700"
                    >Archivo (.txt, .xlsx, .xls)</label
                  >
                  <input
                    type="file"
                    accept=".txt,.xlsx,.xls"
                    @change="onBatchUploadFileChange($event)"
                    class="mt-1"
                  />
                </div>

                <div class="flex items-center gap-3">
                  <label class="inline-flex items-center">
                    <input type="checkbox" x-model="batchUploadDryRun" />
                    <span class="ml-2 text-sm text-gray-700"
                      >Dry run (validar sin guardar)</span
                    >
                  </label>
                </div>

                <!-- Inline validation error -->
                <div
                  x-show="batchUploadError"
                  x-text="batchUploadError"
                  class="text-sm text-red-600 mt-2"
                  style="display: none"
                ></div>

                <!-- Tooltip when Procesar is disabled -->
                <div
                  class="mt-2 text-xs text-gray-500"
                  x-show="!batchUploadEventId || !batchUploadDepartment || !batchUploadActivityId || !batchUploadFile"
                >
                  <span
                    title="Selecciona un evento, departamento, actividad y un archivo para habilitar Procesar"
                    >Necesitas seleccionar evento, departamento, actividad y un
                    archivo para procesar</span
                  >
                </div>
              </div>
            </div>

            <!-- Vista Resultado -->
            <div x-show="batchUploadView === 'report'" x-cloak>
              <template x-if="batchUploadReport">
                <div class="border-t pt-3">
                  <h4 class="font-medium">Resultado</h4>
                  <div class="mt-2 text-sm text-gray-700">
                    <div class="grid grid-cols-3 gap-4 text-sm">
                      <div>
                        <div class="text-xs text-gray-500">Creadas</div>
                        <div
                          class="font-semibold text-green-700"
                          x-text="batchUploadReport.created || 0"
                        ></div>
                      </div>
                      <div>
                        <div class="text-xs text-yellow-600">Omitidas</div>
                        <div
                          class="font-semibold text-yellow-700"
                          x-text="batchUploadReport.skipped || 0"
                        ></div>
                      </div>
                      <div>
                        <div class="text-xs text-red-600">No encontradas</div>
                        <div
                          class="font-semibold text-red-700"
                          x-text="batchUploadReport.not_found || 0"
                        ></div>
                      </div>
                    </div>

                    <!-- Detalles -->
                    <div class="mt-3">
                      <template
                        x-if="batchUploadReport.details && batchUploadReport.details.length"
                      >
                        <div
                          class="max-h-64 overflow-auto border rounded-md bg-white mt-2 p-2 text-sm"
                        >
                          <table class="min-w-full text-sm">
                            <thead>
                              <tr class="text-left text-gray-600 text-xs">
                                <th class="pr-2">Número de control</th>
                                <th class="pr-2">Estudiante</th>
                                <th class="pr-2">Acción</th>
                              </tr>
                            </thead>
                            <tbody>
                              <template
                                x-for="d in batchUploadReport.details"
                                :key="d.control_number"
                              >
                                <tr class="border-t">
                                  <td
                                    class="pr-2 text-gray-700"
                                    x-text="d.control_number"
                                  ></td>
                                  <td
                                    class="pr-2 text-gray-700"
                                    x-text="d.student_name || '-'"
                                  ></td>
                                  <td
                                    class="pr-2"
                                    :class="d.action === 'created' ? 'text-green-700' : 'text-yellow-700'"
                                    x-text="d.action === 'created' ? 'Creada' : 'Omitida'"
                                  ></td>
                                </tr>
                              </template>
                            </tbody>
                          </table>
                        </div>
                      </template>
                    </div>

                    <!-- Errores -->
                    <div class="mt-3">
                      <template
                        x-if="batchUploadReport.errors && batchUploadReport.errors.length"
                      >
                        <div>
                          <div class="text-sm font-medium text-red-600">
                            Errores
                          </div>
                          <div
                            class="max-h-32 overflow-auto border rounded-md bg-red-50 mt-1 p-2 text-xs text-red-800"
                          >
                            <template
                              x-for="err in batchUploadReport.errors"
                              :key="err.control_number"
                            >
                              <div class="py-1 border-b border-red-200">
                                <span
                                  x-text="err.control_number ? err.control_number + ': ' : ''"
                                ></span>
                                <span x-text="err.message"></span>
                              </div>
                            </template>
                          </div>
                        </div>
                      </template>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>

        <!-- Botones de acción -->
        <div class="mt-5 sm:mt-4 sm:flex sm:flex-row-reverse">
          <button
            type="button"
            @click="submitBatchUpload()"
            :disabled="!batchUploadEventId || !batchUploadDepartment || !batchUploadActivityId || !batchUploadFile || batchUploadUploading"
            class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <template x-if="batchUploadUploading">
              <span>Procesando...</span>
            </template>
            <template x-if="!batchUploadUploading">
              <span>Procesar</span>
            </template>
          </button>
          <button
            type="button"
            @click="closeBatchUploadModal()"
            class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
          >
            Cerrar
          </button>
        </div>

        <!-- Progress bar (opcional) -->
        <template x-if="batchUploadProgress > 0 && batchUploadUploading">
          <div class="mt-4">
            <div class="w-full bg-gray-200 rounded-full h-2">
              <div
                class="bg-blue-600 h-2 rounded-full transition-all"
                :style="'width: ' + batchUploadProgress + '%'"
              ></div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
</div>
