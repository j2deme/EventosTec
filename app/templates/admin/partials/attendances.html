<div x-data="attendancesAdmin()" x-init="init()">
  <div
    class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6"
  >
    <div>
      <h2 class="text-2xl font-bold text-gray-900">Gestión de Asistencias</h2>
      <p class="mt-1 text-sm text-gray-600">
        Controla asistencias directas (walk-ins) y registros
      </p>
    </div>
    <div class="mt-4 sm:mt-0 inline-flex items-center space-x-3">
      <button
        @click="openRegister()"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500"
      >
        <i class="ti ti-plus mr-2"></i>
        Registrar asistencia
      </button>
      <button
        @click="$dispatch('open-assign-modal')"
        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
      >
        <i class="ti ti-user-plus mr-2"></i>
        Asignar manual
      </button>
    </div>
  </div>
  <!-- Búsqueda y filtros compactos -->
  <!-- Search/filter card matching 'Registros' layout -->
  <div class="mb-6">
    <div class="bg-white rounded-lg shadow p-4">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="md:col-span-1">
          <label
            for="search"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Buscar</label
          >
          <div class="relative rounded-md shadow-sm">
            <div
              class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"
            >
              <i class="ti ti-search text-gray-400"></i>
            </div>
            <input
              type="text"
              id="search"
              x-model="filters.search"
              @input.debounce.300ms="refresh()"
              class="focus:ring-indigo-500 focus:border-indigo-500 block w-full pl-10 py-2 sm:text-sm border-gray-300 rounded-md"
              placeholder="Número de control, nombre de estudiante, actividad..."
            />
          </div>
        </div>
        <div>
          <label
            for="event_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Evento</label
          >
          <select
            id="event_id"
            x-model="filters.event_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los eventos</option>
            <template x-for="e in events" :key="e.id">
              <option
                :value="e.id"
                x-text="e.name || e.title || ('Evento ' + e.id)"
              ></option>
            </template>
          </select>
        </div>

        <div>
          <label
            for="activity_id"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Actividad</label
          >
          <select
            id="activity_id"
            x-model="filters.activity_id"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todas las actividades</option>
            <template x-for="a in filteredActivities()" :key="a.id">
              <option
                :value="a.id"
                x-text="a.name + ' — ' + (a.event_name || a.event_id || '')"
              ></option>
            </template>
          </select>
        </div>

        <div>
          <label
            for="status"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Estado</label
          >
          <select
            id="status"
            x-model="filters.only_without_registration"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option :value="false">Todos</option>
            <option :value="true">Solo walk-ins</option>
          </select>
        </div>

        <div>
          <label
            for="activity_type"
            class="block text-sm font-medium text-gray-700 mb-1"
            >Tipo de actividad</label
          >
          <select
            id="activity_type"
            x-model="filters.activity_type"
            @change="refresh()"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
          >
            <option value="">Todos los tipos</option>
            <template x-for="t in activityTypes" :key="t">
              <option :value="t" x-text="t"></option>
            </template>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- stat cards (mejoradas) -->
  <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-check text-indigo-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Asistencias hoy</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsToday || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-arrow-up-right text-green-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Walk-ins</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsWalkins || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-repeat text-yellow-500 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">
                Registros convertidos
              </dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsConverted || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-white overflow-hidden shadow rounded-lg">
      <div class="p-5">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <i class="ti ti-alert-triangle text-red-600 text-2xl"></i>
          </div>
          <div class="ml-5 w-0 flex-1">
            <dl>
              <dt class="text-xs text-gray-500 truncate">Errores recientes</dt>
              <dd
                class="text-lg font-semibold text-gray-900"
                x-text="statsErrors || 0"
              ></dd>
            </dl>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- tabla -->
  <div id="attendances-list-container" class="mt-6">
    <div id="search-results" class="mt-0">
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
        <div class="px-4 py-5 sm:p-6">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-semibold">Asistencias</h3>
            <!-- Eliminado buscador y botón: edición por fila individual -->
          </div>

          <div class="overflow-x-auto">
            <!-- Indicador de carga -->
            <div x-show="loading" class="py-8 text-center text-gray-500">
              Cargando asistencias...
            </div>
            <table x-show="!loading" class="min-w-full table-auto text-sm">
              <thead>
                <tr class="bg-gray-50">
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTUDIANTE
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACTIVIDAD
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ESTADO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    FECHA REGISTRO
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    ACCIONES
                  </th>
                </tr>
              </thead>
              <tbody>
                <template
                  x-for="row in attendancesTableFiltered"
                  :key="row.key"
                >
                  <tr class="border-t hover:bg-gray-50">
                    <td class="px-6 py-4 align-top">
                      <div
                        class="font-medium text-gray-900"
                        x-text="row.student_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.student_identifier"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <div
                        class="text-gray-900"
                        x-text="row.activity_name"
                      ></div>
                      <div
                        class="text-xs text-gray-500 mt-1"
                        x-text="row.event_name"
                      ></div>
                    </td>

                    <td class="px-6 py-4 align-top">
                      <!-- Estado como pill -->
                      <template x-if="row.status === 'present'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'registered'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="row.status === 'error'">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800"
                          x-text="row.statusLabel"
                        ></span>
                      </template>
                      <template x-if="!row.status">
                        <span
                          class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-700"
                          x-text="row.statusLabel || '—'"
                        ></span>
                      </template>
                    </td>

                    <td
                      class="px-6 py-4 align-top text-sm text-gray-600"
                      x-text="row.date_display"
                    ></td>

                    <td class="px-6 py-4 align-top">
                      <div class="flex items-center space-x-2">
                        <button
                          @click="openEditor(row)"
                          class="text-indigo-600 hover:text-indigo-800 p-2 rounded"
                          title="Editar"
                        >
                          <i class="ti ti-pencil"></i>
                        </button>

                        <button
                          @click="quickTogglePresent(row)"
                          class="text-green-600 hover:text-green-800 p-2 rounded"
                          title="Marcar presente"
                        >
                          <i class="ti ti-check"></i>
                        </button>

                        <button
                          x-show="row.registration_id"
                          @click="goToRegistration(row)"
                          class="text-gray-600 hover:text-gray-800 p-2 rounded"
                          title="Ver registro"
                        >
                          <i class="ti ti-book-open"></i>
                        </button>

                        <button
                          @click="deleteAttendance(row)"
                          class="text-red-600 hover:text-red-800 p-2 rounded"
                          title="Eliminar"
                        >
                          <i class="ti ti-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </template>

                <tr x-show="!loading && attendancesTableFiltered.length === 0">
                  <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                    No se encontraron registros
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- contenedor oculto para el modal/assign (compatibilidad con dispatch) -->
      <div
        id="attendances-assign-container"
        x-cloak
        style="display: none"
      ></div>
    </div>

    <!-- Modal simple para registrar -->
    <div
      x-show="showModal"
      x-cloak
      style="display: none"
      class="fixed inset-0 z-50 flex items-center justify-center"
    >
      <div
        class="bg-black bg-opacity-50 absolute inset-0"
        @click="closeModal()"
      ></div>
      <div class="bg-white rounded p-6 z-10 w-full max-w-md">
        <h3 class="text-lg font-semibold mb-4">Registrar asistencia</h3>
        <div class="mb-3">
          <label class="block text-sm">Estudiante ID</label>
          <input
            x-model="modalStudentId"
            id="modal-student-id"
            class="mt-1 block w-full rounded border-gray-300"
          />
        </div>
        <div class="mb-3">
          <label class="block text-sm">Actividad ID</label>
          <input
            x-model="modalActivityId"
            id="modal-activity-id"
            class="mt-1 block w-full rounded border-gray-300"
          />
        </div>
        <div class="mb-3">
          <label class="inline-flex items-center">
            <input
              x-model="modalMarkPresent"
              id="modal-mark-present"
              type="checkbox"
              class="form-checkbox"
            />
            <span class="ml-2">Marcar como presente (100%)</span>
          </label>
        </div>
        <div class="flex justify-end space-x-2">
          <button @click="closeModal()" class="px-3 py-2 bg-gray-200 rounded">
            Cancelar
          </button>
          <button
            @click="submitModal()"
            class="px-3 py-2 bg-indigo-600 text-white rounded"
          >
            Registrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
