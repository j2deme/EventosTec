<!-- app/templates/admin/partials/reports.html -->
<div x-data="reportsManager()" x-init="init()">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">
    Reportes y Estadísticas
  </h2>

  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Evento</label
        >
        <select
          x-model="filters.event_id"
          @change="onEventChange"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
        >
          <option value="">Seleccionar evento</option>
          <template x-for="ev in events" :key="ev.id">
            <option :value="ev.id" x-text="ev.name"></option>
          </template>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Actividad (opcional)</label
        >
        <select
          x-model="filters.activity_id"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
        >
          <option value="">Todas las actividades</option>
          <template x-for="act in activitiesFiltered" :key="act.id">
            <option :value="act.id" x-text="act.name"></option>
          </template>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Departamento</label
        >
        <select
          x-model="filters.department"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
        >
          <option value="">Todos los departamentos</option>
          <template x-for="d in departments" :key="d">
            <option :value="d" x-text="d"></option>
          </template>
        </select>
      </div>

      <div class="flex items-end">
        <button
          @click="generateMatrix"
          class="ml-auto inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md"
        >
          Generar matriz
        </button>
      </div>
    </div>
  </div>

  <div class="bg-white rounded-lg shadow p-4">
    <div x-show="loading" class="py-6">
      <div class="overflow-x-auto">
        <div class="min-w-full bg-white rounded">
          <!-- header skeleton (hidden on small screens) -->
          <div
            class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
          >
            <div class="w-1/3 h-4 bg-gray-200 rounded animate-pulse mr-4"></div>
            <div class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"></div>
            <div class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"></div>
            <div
              class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
            ></div>
            <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
          </div>
          <!-- rows skeleton -->
          <div class="space-y-3 p-4">
            <template x-for="i in [1,2,3]" :key="i">
              <div class="flex items-center space-x-4">
                <div
                  class="w-1/3 h-4 bg-gray-200 rounded animate-pulse"
                  :style="{width: (30 + Math.floor(Math.random() * 60)) + '%'}"
                ></div>
                <div class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"></div>
                <div class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"></div>
                <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
                <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <div x-show="!loading">
      <template
        x-if="(matrix_semester && semesters && semesters.length) || (matrix && (generations || []).length)"
      >
        <div class="overflow-hidden">
          <div class="w-full overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 table-fixed">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">Carrera \ Semestre</th>
                  <!-- Preferir semesters/matrix_semester si están presentes -->
                  <template
                    x-if="matrix_semester && semesters && semesters.length"
                  >
                    <template x-for="sem in semesters" :key="sem">
                      <th
                        class="px-4 py-2 text-center"
                        x-text="formatSemester(sem)"
                      ></th>
                    </template>
                  </template>
                  <template
                    x-if="!(matrix_semester && semesters && semesters.length)"
                  >
                    <template x-for="gen in (generations || [])" :key="gen">
                      <th
                        class="px-4 py-2 text-center"
                        x-text="gen || 'Sin generación'"
                      ></th>
                    </template>
                  </template>
                  <th class="px-4 py-2 text-center">Total por carrera</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="career in careers" :key="career">
                  <tr>
                    <td class="px-4 py-2 font-medium" x-text="career"></td>
                    <!-- Mostrar por semestre si existe matrix_semester, sino por generación -->
                    <template
                      x-if="matrix_semester && matrix_semester[String(career)]"
                    >
                      <template x-for="sem in semesters" :key="sem">
                        <td
                          class="px-4 py-2 text-center"
                          x-text="(matrix_semester[String(career)] && matrix_semester[String(career)][sem]) ? matrix_semester[String(career)][sem] : 0"
                        ></td>
                      </template>
                      <td
                        class="px-4 py-2 text-center font-semibold"
                        x-text="(rowSubtotals && rowSubtotals[String(career)]) || 0"
                      ></td>
                    </template>
                    <template
                      x-if="!matrix_semester || !matrix_semester[career]"
                    >
                      <template x-for="gen in (generations || [])" :key="gen">
                        <td
                          class="px-4 py-2 text-center"
                          x-text="(matrix[career] && matrix[career][gen]) ? matrix[career][gen] : 0"
                        ></td>
                      </template>
                      <!-- Subtotal por carrera -->
                      <td
                        class="px-4 py-2 text-center font-semibold"
                        x-text="(generations || []).reduce((sum, g) => sum + ((matrix[career] && matrix[career][g]) ? matrix[career][g] : 0), 0)"
                      ></td>
                    </template>
                  </tr>
                </template>
                <!-- Fila de totales por generación -->
                <tr class="bg-gray-50">
                  <td class="px-4 py-2 font-medium">Total por Semestre</td>
                  <!-- Totales por semestre si existen -->
                  <template
                    x-if="matrix_semester && semesters && semesters.length"
                  >
                    <template x-for="sem in semesters" :key="sem">
                      <td
                        class="px-4 py-2 text-center font-semibold"
                        x-text="(careers || []).reduce((s, c) => s + ((matrix_semester[c] && matrix_semester[c][sem]) ? matrix_semester[c][sem] : 0), 0)"
                      ></td>
                    </template>
                    <td
                      class="px-4 py-2 text-center font-bold"
                      x-text="totalSumSemesters || 0"
                    ></td>
                  </template>
                  <template
                    x-if="!(matrix_semester && semesters && semesters.length)"
                  >
                    <template x-for="gen in generations" :key="gen">
                      <td
                        class="px-4 py-2 text-center font-semibold"
                        x-text="(careers || []).reduce((s, c) => s + ((matrix[c] && matrix[c][gen]) ? matrix[c][gen] : 0), 0)"
                      ></td>
                    </template>
                    <td
                      class="px-4 py-2 text-center font-bold"
                      x-text="(careers || []).reduce((s, c) => s + (generations || []).reduce((ss, g) => ss + ((matrix[c] && matrix[c][g]) ? matrix[c][g] : 0), 0), 0)"
                    ></td>
                  </template>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </template>

      <div
        x-show="(!matrix || (generations || []).length === 0) && !loading"
        class="p-6 text-center text-gray-500"
      >
        No hay datos para la selección actual.
      </div>
    </div>
  </div>
  <!-- New: Fill report (porcentaje de llenado) -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h3 class="text-lg font-medium text-gray-900">
          % Llenado por Actividad
        </h3>
        <p class="text-sm text-gray-500">
          Visualiza actividades llenas, vacías o sin cupo definido.
        </p>
      </div>
      <div class="flex items-center space-x-2">
        <button
          @click.prevent="generateFillReport()"
          class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md"
        >
          Generar % llenado
        </button>
        <button
          @click.prevent="downloadRegistrationsTxt()"
          class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-800 rounded-md border"
          title="Descargar lista única de inscritos (TXT)"
        >
          Descargar inscritos (.txt)
        </button>
      </div>
    </div>

    <div class="mt-4">
      <div x-show="fillLoading" class="py-4">
        <div class="overflow-x-auto">
          <div class="min-w-full bg-white rounded">
            <!-- header skeleton -->
            <div
              class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
            >
              <div
                class="w-1/4 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <!-- rows skeleton -->
            <div class="space-y-3 p-4">
              <template x-for="i in [1,2,3]" :key="i">
                <div class="flex items-center space-x-4">
                  <div
                    class="w-1/4 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div class="w-1/12 flex items-center">
                    <div class="w-full bg-gray-100 rounded-full h-3 mr-2">
                      <div
                        class="h-3 bg-gray-300 rounded-full animate-pulse"
                        :style="{width: (25 + Math.floor(Math.random() * 66)) + '%'}"
                      ></div>
                    </div>
                    <div
                      class="w-10 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <div x-show="!fillLoading && fillReport && fillReport.length">
        <div class="w-full overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left">Actividad</th>
                <th class="px-4 py-2 text-left">Evento</th>
                <th class="px-4 py-2 text-left">Modalidad</th>
                <th class="px-4 py-2 text-center">Cupo</th>
                <th class="px-4 py-2 text-center">Inscritos</th>
                <th class="px-4 py-2 text-center">% Llenado</th>
                <th class="px-4 py-2 text-center">Estado</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="act in fillReport" :key="act.id">
                <tr>
                  <td class="px-4 py-2" x-text="act.name"></td>
                  <td class="px-4 py-2" x-text="act.event_name || ''"></td>
                  <td class="px-4 py-2" x-text="act.modality || ''"></td>
                  <td
                    class="px-4 py-2 text-center"
                    x-text="act.capacity == null ? '∞' : act.capacity"
                  ></td>
                  <td
                    class="px-4 py-2 text-center"
                    x-text="act.current_registrations"
                  ></td>
                  <td class="px-4 py-2 w-48">
                    <div x-show="act.capacity != null">
                      <div
                        class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"
                      >
                        <div
                          :style="{width: Math.min(act.percent || 0, 100) + '%'}"
                          :class="(
                            act.status === 'full' ? 'h-3 bg-green-500' : (
                              act.status === 'empty' ? 'h-3 bg-red-500' : (
                                act.status === 'available' ? 'h-3 bg-amber-500' : 'h-3 bg-blue-500'
                              )
                            )
                          )"
                        ></div>
                      </div>
                      <div
                        class="text-xs text-gray-600 mt-1"
                        x-text="act.percent + '%'"
                      ></div>
                    </div>
                    <div
                      x-show="act.capacity == null"
                      class="text-sm text-gray-500"
                    >
                      Sin cupo
                    </div>
                  </td>
                  <td class="px-4 py-2 text-center">
                    <span
                      class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                      :class="act.status_badge_class || 'bg-gray-100 text-gray-800'"
                      x-text="act.status_label || act.status"
                    >
                    </span>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>

      <div
        x-show="!fillLoading && (!fillReport || fillReport.length === 0)"
        class="p-6 text-center text-gray-500"
      >
        No hay datos para el reporte de llenado.
      </div>
    </div>

    <!-- New: Hours Compliance Report -->
    <div class="bg-white rounded-lg shadow p-4 mb-6 mt-6">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h3 class="text-lg font-medium text-gray-900">
            Reporte de Cumplimiento de Horas
          </h3>
          <p class="text-sm text-gray-500">
            Consulta las horas acumuladas por estudiante en participaciones
            confirmadas.
          </p>
        </div>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Evento *</label
          >
          <select
            x-model="hoursFilters.event_id"
            @change="onHoursEventChange"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
          >
            <option value="">Seleccionar evento</option>
            <template x-for="ev in events" :key="ev.id">
              <option :value="ev.id" x-text="ev.name"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Carrera (opcional)</label
          >
          <select
            x-model="hoursFilters.career"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
          >
            <option value="">Todas las carreras</option>
            <template x-for="c in uniqueCareers" :key="c">
              <option :value="c" x-text="c"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Buscar estudiante</label
          >
          <input
            type="text"
            x-model="hoursFilters.search"
            placeholder="Número de control o nombre"
            class="mt-1 block w-full px-3 py-2 text-base border-gray-300 rounded-md"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Horas mínimas</label
          >
          <input
            type="number"
            x-model="hoursFilters.min_hours"
            placeholder="0"
            min="0"
            step="0.5"
            class="mt-1 block w-full px-3 py-2 text-base border-gray-300 rounded-md"
          />
        </div>
      </div>

      <!-- Filter toggle for 10+ hours -->
      <div class="mb-4">
        <label class="inline-flex items-center cursor-pointer">
          <input
            type="checkbox"
            x-model="hoursFilters.filter_10_plus"
            @change="apply10PlusFilter"
            class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
          />
          <span class="ml-2 text-sm text-gray-700"
            >Mostrar solo estudiantes con 10+ horas (acreditados para crédito
            complementario)</span
          >
        </label>
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2 mb-4">
        <button
          @click="generateHoursReport"
          :disabled="!hoursFilters.event_id"
          class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Generar reporte
        </button>
        <button
          @click="downloadHoursExcel"
          :disabled="!hoursStudents || hoursStudents.length === 0"
          class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Descargar Excel
        </button>
      </div>

      <!-- Loading state -->
      <div x-show="hoursLoading" class="py-4">
        <div class="overflow-x-auto">
          <div class="min-w-full bg-white rounded">
            <div
              class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
            >
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/3 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/4 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <div class="space-y-3 p-4">
              <template x-for="i in [1,2,3]" :key="i">
                <div class="flex items-center space-x-4">
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/3 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/4 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Results table -->
      <div x-show="!hoursLoading && hoursStudents && hoursStudents.length > 0">
        <div class="w-full overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left">Número de Control</th>
                <th class="px-4 py-2 text-left">Nombre Completo</th>
                <th class="px-4 py-2 text-left">Carrera</th>
                <th class="px-4 py-2 text-center">Horas Acumuladas</th>
                <th class="px-4 py-2 text-center">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="student in hoursStudents" :key="student.id">
                <tr>
                  <td class="px-4 py-2" x-text="student.control_number"></td>
                  <td class="px-4 py-2" x-text="student.full_name"></td>
                  <td class="px-4 py-2" x-text="student.career"></td>
                  <td class="px-4 py-2 text-center">
                    <span
                      class="font-semibold"
                      x-text="student.total_hours"
                    ></span>
                    <span
                      x-show="student.total_hours >= 10"
                      class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                    >
                      Acreditado
                    </span>
                  </td>
                  <td class="px-4 py-2 text-center">
                    <button
                      @click="viewParticipationDetails(student.id)"
                      class="text-indigo-600 hover:text-indigo-900 text-sm"
                    >
                      Ver detalle
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-sm text-gray-600">
          Total de estudiantes:
          <span class="font-semibold" x-text="hoursStudents.length"></span>
        </div>
      </div>

      <!-- Empty state -->
      <div
        x-show="!hoursLoading && (!hoursStudents || hoursStudents.length === 0)"
        class="p-6 text-center text-gray-500"
      >
        No hay datos para el reporte. Selecciona un evento y genera el reporte.
      </div>
    </div>

    <!-- Modal for participation details -->
    <div
      x-show="showParticipationModal"
      x-cloak
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="showParticipationModal = false"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        ></div>
        <div class="relative bg-white rounded-lg max-w-4xl w-full p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-medium text-gray-900">
                Detalle de Participaciones
              </h3>
              <p class="text-sm text-gray-500" x-show="currentStudent">
                <span x-text="currentStudent?.control_number"></span> -
                <span x-text="currentStudent?.full_name"></span>
              </p>
            </div>
            <button
              @click="showParticipationModal = false"
              class="text-gray-400 hover:text-gray-500"
            >
              <span class="sr-only">Cerrar</span>
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Participations list -->
          <div x-show="participationDetailsLoading" class="py-4 text-center">
            <div class="animate-pulse">Cargando participaciones...</div>
          </div>

          <div
            x-show="!participationDetailsLoading && participationDetails && participationDetails.length > 0"
          >
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left">Actividad</th>
                    <th class="px-4 py-2 text-left">Fecha y Hora</th>
                    <th class="px-4 py-2 text-left">Tipo</th>
                    <th class="px-4 py-2 text-center">Horas</th>
                    <th class="px-4 py-2 text-center">Estado</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <template x-for="part in participationDetails" :key="part.id">
                    <tr>
                      <td class="px-4 py-2">
                        <div class="font-medium" x-text="part.name"></div>
                        <div
                          class="text-sm text-gray-500"
                          x-text="part.location"
                        ></div>
                      </td>
                      <td
                        class="px-4 py-2 text-sm"
                        x-text="formatDateTime(part.start_datetime)"
                      ></td>
                      <td
                        class="px-4 py-2 text-sm"
                        x-text="part.activity_type"
                      ></td>
                      <td
                        class="px-4 py-2 text-center font-medium"
                        x-text="part.duration_hours"
                      ></td>
                      <td class="px-4 py-2 text-center">
                        <span
                          class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                          x-text="part.status"
                        ></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td colspan="3" class="px-4 py-2 text-right font-medium">
                      Total de horas:
                    </td>
                    <td
                      class="px-4 py-2 text-center font-bold"
                      x-text="(typeof totalParticipationHours !== 'undefined' ? totalParticipationHours : 0)"
                    ></td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div
            x-show="!participationDetailsLoading && (!participationDetails || participationDetails.length === 0)"
            class="py-4 text-center text-gray-500"
          >
            No hay participaciones confirmadas.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
