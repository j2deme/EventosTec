<!-- app/templates/admin/partials/reports.html -->
<div x-data="reportsManager()" x-init="init()">
  <h2 class="text-xl font-semibold text-gray-900 mb-4">
    Reportes y Estadísticas
  </h2>

  <!-- FILTROS GENERALES -->
  <div class="bg-white rounded-lg shadow p-4 mb-6">
    <h3 class="text-base font-medium text-gray-900 mb-4">Filtros Generales</h3>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Evento</label
        >
        <select
          x-model="filters.event_id"
          @change="onEventChange"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
        >
          <option value="">Seleccionar evento</option>
          <template x-for="ev in events" :key="ev.id">
            <option :value="ev.id" x-text="ev.name"></option>
          </template>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Actividad (opcional)</label
        >
        <select
          x-model="filters.activity_id"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md transition-all duration-300"
          :class="activitiesFilterLoading ? 'opacity-60 bg-blue-50' : 'opacity-100'"
          :disabled="activitiesFilterLoading"
        >
          <option value="">Todas las actividades</option>
          <template x-for="act in activitiesFiltered" :key="act.id">
            <option :value="act.id" x-text="act.name"></option>
          </template>
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1"
          >Departamento</label
        >
        <select
          x-model="filters.department"
          class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
        >
          <option value="">Todos los departamentos</option>
          <template x-for="d in departments" :key="d">
            <option :value="d" x-text="d"></option>
          </template>
        </select>
      </div>

      <div class="flex items-end">
        <button
          @click="generateMatrix"
          :disabled="!filters.event_id"
          class="ml-auto inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Generar matriz
        </button>
      </div>
    </div>

    <!-- REPORTE 1: Matriz de Participación -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900">
          1. Matriz de Participación
        </h3>
        <p class="text-sm text-gray-500">
          Visualiza la participación de estudiantes por carrera y
          semestre/generación.
        </p>
      </div>

      <!-- Loading state -->
      <div x-show="loading" class="py-4">
        <div class="overflow-x-auto">
          <div class="min-w-full bg-white rounded">
            <!-- header skeleton (hidden on small screens) -->
            <div
              class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
            >
              <div
                class="w-1/3 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <!-- rows skeleton -->
            <div class="space-y-3 p-4">
              <template x-for="i in [1,2,3]" :key="i">
                <div class="flex items-center space-x-4">
                  <div
                    class="w-1/3 h-4 bg-gray-200 rounded animate-pulse"
                    :style="{width: (30 + Math.floor(Math.random() * 60)) + '%'}"
                  ></div>
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <div x-show="!loading">
        <!-- Usamos la tabla simplificada que proviene del backend -->
        <template x-if="matrix_rows && matrix_rows.length">
          <div class="overflow-hidden">
            <div class="w-full overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 table-fixed">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left">Carrera</th>
                    <template x-for="(h, idx) in matrix_headers" :key="idx">
                      <th
                        class="px-4 py-2 text-center"
                        x-text="formatSemester(h)"
                      ></th>
                    </template>
                    <th class="px-4 py-2 text-center">Total por carrera</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <template x-for="(r, rIdx) in matrix_rows" :key="rIdx">
                    <tr>
                      <td class="px-4 py-2 font-medium" x-text="r[0]"></td>
                      <template x-for="(h, idx) in matrix_headers" :key="idx">
                        <td
                          class="px-4 py-2 text-center font-mono"
                          x-text="r[idx + 1]"
                        ></td>
                      </template>
                      <td
                        class="px-4 py-2 text-center font-semibold font-mono"
                        x-text="formatNumber(r[r.length - 1])"
                      ></td>
                    </tr>
                  </template>
                  <tr class="bg-gray-50">
                    <td
                      class="px-4 py-2 font-medium"
                      x-text="matrix_footer && matrix_footer.length ? matrix_footer[0] : 'Total'"
                    ></td>
                    <template x-for="(h, idx) in matrix_headers" :key="idx">
                      <td
                        class="px-4 py-2 text-center font-semibold font-mono"
                        x-text="matrix_footer && matrix_footer.length ? formatNumber(matrix_footer[idx + 1]) : formatNumber(0)"
                      ></td>
                    </template>
                    <td
                      class="px-4 py-2 text-center font-bold font-mono"
                      x-text="matrix_footer && matrix_footer.length ? formatNumber(matrix_footer[matrix_footer.length - 1]) : formatNumber(0)"
                    ></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </template>

        <div
          x-show="(!matrix_rows || matrix_rows.length === 0) && !loading"
          class="p-6 text-center text-gray-500"
        >
          No hay datos para la selección actual.
        </div>
      </div>
    </div>

    <!-- REPORTE 2: Porcentaje de Llenado por Actividad -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900">
          2. % Llenado por Actividad
        </h3>
        <p class="text-sm text-gray-500">
          Visualiza actividades llenas, vacías o sin cupo definido.
        </p>
      </div>

      <div class="flex items-center justify-between mb-4">
        <div></div>
        <div class="flex items-center space-x-2">
          <button
            @click.prevent="generateFillReport()"
            :disabled="!filters.event_id"
            class="inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Generar % llenado
          </button>
          <button
            @click.prevent="downloadRegistrationsTxt()"
            :disabled="!filters.event_id"
            class="inline-flex items-center px-3 py-2 bg-gray-100 text-gray-800 rounded-md border disabled:opacity-50 disabled:cursor-not-allowed"
            title="Descargar lista única de inscritos (TXT)"
          >
            Descargar inscritos (.txt)
          </button>
        </div>
      </div>

      <div class="mt-4">
        <div x-show="fillLoading" class="py-4">
          <div class="overflow-x-auto">
            <div class="min-w-full bg-white rounded">
              <!-- header skeleton -->
              <div
                class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
              >
                <div
                  class="w-1/4 h-4 bg-gray-200 rounded animate-pulse mr-4"
                ></div>
                <div
                  class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
                ></div>
                <div
                  class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
                ></div>
                <div
                  class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
                ></div>
                <div
                  class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
                ></div>
                <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
              </div>
              <!-- rows skeleton -->
              <div class="space-y-3 p-4">
                <template x-for="i in [1,2,3]" :key="i">
                  <div class="flex items-center space-x-4">
                    <div
                      class="w-1/4 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                    <div
                      class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                    <div
                      class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                    <div
                      class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                    <div
                      class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                    ></div>
                    <div class="w-1/12 flex items-center">
                      <div class="w-full bg-gray-100 rounded-full h-3 mr-2">
                        <div
                          class="h-3 bg-gray-300 rounded-full animate-pulse"
                          :style="{width: (25 + Math.floor(Math.random() * 66)) + '%'}"
                        ></div>
                      </div>
                      <div
                        class="w-10 h-4 bg-gray-200 rounded animate-pulse"
                      ></div>
                    </div>
                  </div>
                </template>
              </div>
            </div>
          </div>
        </div>

        <div x-show="!fillLoading && fillReport && fillReport.length">
          <div class="w-full overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-2 text-left">Actividad</th>
                  <th class="px-4 py-2 text-left">Evento</th>
                  <th class="px-4 py-2 text-left">Modalidad</th>
                  <th class="px-4 py-2 text-center">Cupo</th>
                  <th class="px-4 py-2 text-center">Inscritos</th>
                  <th class="px-4 py-2 text-center">% Llenado</th>
                  <th class="px-4 py-2 text-center">Estado</th>
                </tr>
              </thead>
              <tbody class="bg-white divide-y divide-gray-200">
                <template x-for="act in fillReport" :key="act.id">
                  <tr>
                    <td class="px-4 py-2" x-text="act.name"></td>
                    <td class="px-4 py-2" x-text="act.event_name || ''"></td>
                    <td class="px-4 py-2" x-text="act.modality || ''"></td>
                    <td
                      class="px-4 py-2 text-center"
                      x-text="act.capacity == null ? '∞' : act.capacity"
                    ></td>
                    <td
                      class="px-4 py-2 text-center"
                      x-text="act.current_registrations"
                    ></td>
                    <td class="px-4 py-2 w-48">
                      <div x-show="act.capacity != null">
                        <div
                          class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"
                        >
                          <div
                            :style="{width: Math.min(act.percent || 0, 100) + '%'}"
                            :class="(
                            act.status === 'full' ? 'h-3 bg-green-500' : (
                              act.status === 'empty' ? 'h-3 bg-red-500' : (
                                act.status === 'available' ? 'h-3 bg-amber-500' : 'h-3 bg-blue-500'
                              )
                            )
                          )"
                          ></div>
                        </div>
                        <span
                          class="text-xs text-gray-600 ml-2"
                          x-text="act.percent + '%'"
                        ></span>
                      </div>
                      <div
                        x-show="act.capacity == null"
                        class="text-sm text-gray-500"
                      >
                        Sin cupo
                      </div>
                    </td>
                    <td class="px-4 py-2 text-center">
                      <span
                        :class="`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${act.status_badge_class}`"
                        x-text="act.status_label"
                      ></span>
                    </td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>

        <div
          x-show="!fillLoading && (!fillReport || fillReport.length === 0)"
          class="p-6 text-center text-gray-500"
        >
          No hay datos para el reporte. Selecciona un evento y genera el reporte
          de llenado.
        </div>
      </div>
    </div>

    <!-- REPORTE 3: Cumplimiento de Horas por Estudiante -->
    <div class="bg-white rounded-lg shadow p-4 mb-6">
      <div class="mb-4">
        <h3 class="text-lg font-medium text-gray-900">
          3. Cumplimiento de Horas por Estudiante
        </h3>
        <p class="text-sm text-gray-500">
          Visualiza estudiantes con horas acumuladas en el evento.
        </p>
      </div>

      <!-- Filters for hours report -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Carrera</label
          >
          <select
            x-model="hoursFilters.career"
            class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 rounded-md"
          >
            <option value="">Todas las carreras</option>
            <template x-for="c in uniqueCareers" :key="c">
              <option :value="c" x-text="c"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Buscar</label
          >
          <input
            type="text"
            x-model="hoursFilters.search"
            placeholder="Número de control o nombre"
            class="mt-1 block w-full px-3 py-2 text-base border-gray-300 rounded-md"
          />
        </div>

        <div class="flex items-end">
          <button
            @click="generateHoursReport"
            :disabled="!filters.event_id"
            class="ml-auto inline-flex items-center px-4 py-2 bg-indigo-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Generar reporte
          </button>
        </div>
      </div>

      <!-- Action buttons -->
      <div class="flex gap-2 mb-4">
        <button
          @click="downloadHoursExcel"
          :disabled="!hoursStudents || hoursStudents.length === 0"
          class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-md disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Descargar Excel
        </button>
      </div>

      <!-- Loading state -->
      <div x-show="hoursLoading" class="py-4">
        <div class="overflow-x-auto">
          <div class="min-w-full bg-white rounded">
            <div
              class="hidden md:flex items-center px-4 py-2 border-b border-gray-100"
            >
              <div
                class="w-1/6 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/3 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/4 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div
                class="w-1/12 h-4 bg-gray-200 rounded animate-pulse mr-4"
              ></div>
              <div class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"></div>
            </div>
            <div class="space-y-3 p-4">
              <template x-for="i in [1,2,3]" :key="i">
                <div class="flex items-center space-x-4">
                  <div
                    class="w-1/6 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/3 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/4 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                  <div
                    class="w-1/12 h-4 bg-gray-200 rounded animate-pulse"
                  ></div>
                </div>
              </template>
            </div>
          </div>
        </div>
      </div>

      <!-- Results table -->
      <div x-show="!hoursLoading && hoursStudents && hoursStudents.length > 0">
        <div class="w-full overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left">Número de Control</th>
                <th class="px-4 py-2 text-left">Nombre Completo</th>
                <th class="px-4 py-2 text-left">Carrera</th>
                <th class="px-4 py-2 text-center">Horas Acumuladas</th>
                <th class="px-4 py-2 text-center">Acciones</th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
              <template x-for="student in hoursStudents" :key="student.id">
                <tr>
                  <td class="px-4 py-2" x-text="student.control_number"></td>
                  <td class="px-4 py-2" x-text="student.full_name"></td>
                  <td class="px-4 py-2" x-text="student.career"></td>
                  <td class="px-4 py-2 text-center">
                    <span
                      class="font-semibold"
                      x-text="student.total_hours"
                    ></span>
                    <span
                      x-show="student.total_hours >= 10"
                      class="ml-2 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                    >
                      Acreditado
                    </span>
                  </td>
                  <td class="px-4 py-2 text-center">
                    <button
                      @click="viewParticipationDetails(student.id)"
                      class="text-indigo-600 hover:text-indigo-900 text-sm"
                    >
                      Ver detalle
                    </button>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div class="mt-4 text-sm text-gray-600">
          Total de estudiantes:
          <span class="font-semibold" x-text="hoursStudents.length"></span>
        </div>
      </div>

      <!-- Empty state -->
      <div
        x-show="!hoursLoading && (!hoursStudents || hoursStudents.length === 0)"
        class="p-6 text-center text-gray-500"
      >
        No hay datos para el reporte. Selecciona un evento y genera el reporte.
      </div>
    </div>

    <!-- Modal for participation details -->
    <div
      x-show="showParticipationModal"
      x-cloak
      class="fixed inset-0 z-50 overflow-y-auto"
      @click.self="showParticipationModal = false"
    >
      <div class="flex items-center justify-center min-h-screen px-4">
        <div
          class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"
        ></div>
        <div class="relative bg-white rounded-lg max-w-4xl w-full p-6">
          <div class="flex items-center justify-between mb-4">
            <div>
              <h3 class="text-lg font-medium text-gray-900">
                Detalle de Participaciones
              </h3>
              <p class="text-sm text-gray-500" x-show="currentStudent">
                <span x-text="currentStudent?.control_number"></span> -
                <span x-text="currentStudent?.full_name"></span>
              </p>
            </div>
            <button
              @click="showParticipationModal = false"
              class="text-gray-400 hover:text-gray-500"
            >
              <span class="sr-only">Cerrar</span>
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>

          <!-- Participations list -->
          <div x-show="participationDetailsLoading" class="py-4 text-center">
            <div class="animate-pulse">Cargando participaciones...</div>
          </div>

          <div
            x-show="!participationDetailsLoading && participationDetails && participationDetails.length > 0"
          >
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-4 py-2 text-left">Actividad</th>
                    <th class="px-4 py-2 text-left">Fecha y Hora</th>
                    <th class="px-4 py-2 text-left">Tipo</th>
                    <th class="px-4 py-2 text-center">Horas</th>
                    <th class="px-4 py-2 text-center">Estado</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <template x-for="part in participationDetails" :key="part.id">
                    <tr>
                      <td class="px-4 py-2">
                        <div class="font-medium" x-text="part.name"></div>
                        <div
                          class="text-sm text-gray-500"
                          x-text="part.location"
                        ></div>
                      </td>
                      <td
                        class="px-4 py-2 text-sm"
                        x-text="formatDateTime(part.start_datetime)"
                      ></td>
                      <td
                        class="px-4 py-2 text-sm"
                        x-text="part.activity_type"
                      ></td>
                      <td
                        class="px-4 py-2 text-center font-medium"
                        x-text="part.duration_hours"
                      ></td>
                      <td class="px-4 py-2 text-center">
                        <span
                          class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"
                          x-text="part.status"
                        ></span>
                      </td>
                    </tr>
                  </template>
                </tbody>
                <tfoot class="bg-gray-50">
                  <tr>
                    <td colspan="3" class="px-4 py-2 text-right font-medium">
                      Total de horas:
                    </td>
                    <td
                      class="px-4 py-2 text-center font-bold"
                      x-text="(typeof totalParticipationHours !== 'undefined' ? totalParticipationHours : 0)"
                    ></td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <div
            x-show="!participationDetailsLoading && (!participationDetails || participationDetails.length === 0)"
            class="py-4 text-center text-gray-500"
          >
            No hay participaciones registradas.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
