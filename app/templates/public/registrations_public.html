{% extends 'base.html' %} {% block title %}Confirmar preregistros{% endblock %}
{% block content %} {% if token_invalid or not activity_id %}
<div
  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4"
>
  <div
    class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl min-h-[40vh] md:min-h-[40vh]"
  >
    <h2 class="text-xl font-bold mb-2">Actividad no encontrada</h2>
    <div class="text-sm text-gray-600 mb-4">
      La actividad referenciada no existe o el enlace público es incorrecto.
      Verifica el enlace o contacta al administrador.
    </div>
    <div class="text-sm text-gray-700">
      {% if event_slug %}
      <a
        href="/public/event/{{ event_slug }}"
        class="text-indigo-600 hover:underline"
        >Volver al evento</a
      >
      {% endif %}
    </div>
  </div>
</div>
{% else %}
<div
  class="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 to-indigo-100 p-4"
>
  <div
    class="bg-white p-6 rounded-xl shadow-lg w-full max-w-4xl min-h-[60vh] md:min-h-[70vh]"
    x-data="registrationsPublic()"
    x-init="init()"
    id="public-registrations-card"
    data-activity-id="{{ activity_id or '' }}"
    data-activity-name="{{ activity_name or '' }}"
    data-activity-type="{{ activity_type or '' }}"
    data-activity-deadline="{{ activity_deadline_iso or '' }}"
    data-activity-start="{{ activity_start_iso or '' }}"
    data-activity-end="{{ activity_end_iso or '' }}"
    data-activity-location="{{ activity_location or '' }}"
    data-activity-modality="{{ activity_modality or '' }}"
    data-event-name="{{ event_name or '' }}"
    data-event-slug="{{ event_slug or '' }}"
  >
    <div class="flex flex-col md:flex-row items-start justify-between mb-4">
      <div class="md:w-1/5 w-full mb-3 md:mb-0">
        <div class="pt-1">
          <button
            x-show="eventName"
            @click.prevent="(function(){
                try {
                  // Use event slug to navigate back
                  if (typeof eventSlug !== 'undefined' && eventSlug) {
                    window.location.href = (window.location.origin || '') + '/public/event/' + encodeURIComponent(eventSlug);
                    return;
                  }
                } catch (e) {
                  // nothing else to do
                }
              })()"
            type="button"
            class="inline-flex items-center text-sm text-indigo-600 bg-transparent border-0 p-0 hover:bg-indigo-50 rounded"
          >
            <i class="ti ti-arrow-left mr-3 text-lg"></i>
            <div class="flex flex-col leading-tight text-left">
              <span
                class="text-sm font-medium text-indigo-600"
                x-text="eventName || 'Evento'"
              ></span>
              <span class="text-xs text-gray-500">Regresar</span>
            </div>
          </button>
        </div>
      </div>

      <div class="md:w-3/5 w-full">
        <div class="flex items-center space-x-3">
          <div
            class="text-2xl font-bold text-gray-800"
            x-text="activityName || 'Actividad'"
          ></div>
          <!-- status badge (responsive) -->
          <div
            x-show="registerState === 'pending'"
            class="inline-flex items-center px-3 py-1 bg-yellow-100 text-yellow-800 rounded text-xs md:text-sm whitespace-nowrap"
            :title="'Por iniciar'"
          >
            Por iniciar
          </div>
          <div
            x-show="registerState === 'open'"
            class="inline-flex items-center px-3 py-1 bg-green-100 text-green-800 rounded text-xs md:text-sm whitespace-nowrap"
            :title="'Abierto'"
          >
            Abierto
          </div>
          <div
            x-show="registerState === 'closed'"
            class="inline-flex items-center px-3 py-1 bg-gray-100 text-gray-700 rounded text-xs md:text-sm whitespace-nowrap"
            :title="'Cerrado'"
          >
            Cerrado
          </div>
        </div>
        <div class="mt-2 flex items-center space-x-3 text-sm text-gray-600">
          <div class="inline-flex items-center space-x-1">
            <i class="ti ti-calendar text-gray-400"></i>
            <span x-text="activityDateRange"></span>
          </div>
          <div class="inline-flex items-center space-x-1">
            <i class="ti ti-map-pin text-gray-400"></i>
            <span x-text="activityLocation || '-'"></span>
          </div>
          <div class="inline-flex items-center space-x-1">
            <i class="ti ti-device-laptop text-gray-400"></i>
            <span x-text="activityModality || '-'"></span>
          </div>
        </div>
        <div class="text-sm text-gray-500 mt-1" x-text="timeLeftText"></div>
        <!-- small legend for source icons -->
        <div class="mt-2 text-xs text-gray-500 flex items-center space-x-4">
          <div class="flex items-center space-x-1">
            <i class="ti ti-list-check text-indigo-600"></i>
            <span>Preregistro</span>
          </div>
          <div class="flex items-center space-x-1">
            <i class="ti ti-check text-green-600"></i>
            <span>Asistencia (sin preregistro)</span>
          </div>
        </div>
      </div>

      <div
        x-show="!controlsEnabled"
        class="md:w-1/5 w-full mt-3 md:mt-0"
        aria-hidden="true"
      ></div>
      <div
        x-show="controlsEnabled"
        x-cloak
        class="md:w-1/5 w-full flex md:justify-end justify-start mt-3 md:mt-0"
      >
        <div class="flex flex-col items-end w-full">
          <button
            @click="openWalkin()"
            :disabled="!controlsEnabled"
            :class="{ 'opacity-50 cursor-not-allowed': !controlsEnabled }"
            class="bg-indigo-600 text-white px-3 py-2 rounded inline-flex items-center space-x-2"
          >
            <i class="ti ti-user-plus"></i>
            <span>Registrar Walk-in</span>
          </button>

          <div class="mt-2 text-sm text-gray-600 w-full">
            <strong>¿Qué es un walk-in?</strong>
            <div>
              Es cuando un estudiante sin preregistro llega a la actividad y se
              le registra su asistencia.
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="mb-4 flex items-center space-x-2">
      <input
        x-model="q"
        @input.debounce.500ms="$nextTick(() => fetchRegs())"
        placeholder="Buscar por nombre o número de control"
        class="flex-1 rounded border p-2"
      />
      <button
        @click.prevent="downloadRegistrations()"
        type="button"
        class="bg-gray-700 text-white px-3 py-2 rounded inline-flex items-center text-sm"
        title="Descargar inscritos"
      >
        <i class="ti ti-users mr-2"></i>
        Lista
      </button>
    </div>

    <!-- Loading indicator -->
    <div x-show="loading" x-cloak class="flex items-center justify-center py-8">
      <div class="flex items-center space-x-3">
        <svg
          class="animate-spin text-indigo-600 w-5 h-5"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
        >
          <circle
            class="opacity-25"
            cx="12"
            cy="12"
            r="10"
            stroke="currentColor"
            stroke-width="2"
          ></circle>
          <path
            class="opacity-75"
            fill="currentColor"
            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
          ></path>
        </svg>
        <span class="text-sm text-gray-600">Cargando registros...</span>
      </div>
    </div>

    <!-- Table container (hidden while loading) -->
    <div x-show="!loading" x-cloak class="space-y-4">
      <div class="overflow-x-auto">
        <table class="w-full table-auto md:table-fixed">
          <thead>
            <tr
              class="text-left text-xs md:text-sm text-gray-600 border-b border-gray-300"
            >
              <th class="p-3 w-10 text-center">Tipo</th>
              <th class="p-3 w-12 text-center">#</th>
              <th class="p-3 w-28 md:w-32">Número</th>
              <th class="p-3 flex-1">Nombre</th>
              <th class="p-3 w-24 md:w-28 text-center">Estado</th>
              <th class="p-3 w-20 text-center">Asistió</th>
            </tr>
          </thead>
          <tbody>
            <template
              x-for="(r, idx) in regs"
              :key="(r.registration_id || r.attendance_id || r.student_id)"
            >
              <tr
                class="transition-colors duration-150 hover:bg-indigo-50 border-b border-gray-100 text-xs md:text-sm"
                x-show="!r._removing"
                x-transition:leave="transition ease-in duration-200 transform"
                x-transition:leave-start="opacity-100 scale-100"
                x-transition:leave-end="opacity-0 -translate-y-2 scale-95"
                x-transition:enter="transition ease-out duration-200 transform"
                x-transition:enter-start="opacity-0 -translate-y-2 scale-95"
                x-transition:enter-end="opacity-100 scale-100"
              >
                <td class="p-3 text-center">
                  <div class="flex items-center justify-center">
                    <i
                      x-show="r.source === 'registration'"
                      class="ti ti-list-check text-indigo-600 text-lg"
                      title="Preregistro"
                      aria-hidden="true"
                    ></i>
                    <i
                      x-show="r.source === 'attendance'"
                      class="ti ti-check text-green-600 text-lg"
                      title="Asistencia (sin preregistro)"
                      aria-hidden="true"
                    ></i>
                  </div>
                </td>
                <td
                  class="p-3 text-center font-medium text-gray-700"
                  x-text="(page-1)*per_page + idx + 1"
                ></td>
                <td
                  class="p-3 text-gray-700 font-mono text-sm"
                  x-text="r.control_number || '-'"
                ></td>
                <td class="p-3 text-gray-800 font-medium">
                  <span
                    class="block"
                    :title="r.student_name"
                    x-text="r.student_name || '-'"
                  ></span>
                </td>
                <td class="p-3 text-center">
                  <div class="flex items-center justify-center">
                    <span
                      class="inline-flex items-center px-2 py-0.5 rounded text-xs md:text-sm font-medium max-w-[160px] truncate whitespace-nowrap overflow-hidden"
                      :title="r.attended ? 'Confirmado' : (registerState === 'closed' ? 'No asistió' : (r.status || 'Pre-registrado'))"
                      :class="{
                        'bg-green-100 text-green-800': r.attended || (r.status && ['Asistió', 'Confirmado'].includes(r.status)),
                        'bg-red-100 text-red-800': !r.attended && registerState === 'closed',
                        'bg-yellow-100 text-yellow-800': !r.attended && registerState !== 'closed' && (r.status && ['Registrado', 'Pre-registrado'].includes(r.status)),
                        'bg-gray-100 text-gray-700': !r.attended && registerState !== 'closed' && !(r.status && ['Registrado', 'Pre-registrado', 'Asistió', 'Confirmado'].includes(r.status))
                      }"
                      x-text="r.attended ? 'Confirmado' : (registerState === 'closed' ? 'No asistió' : (r.status || 'Pre-registrado'))"
                    ></span>
                  </div>
                </td>
                <td class="p-3 text-center">
                  <div class="flex items-center justify-center">
                    <div class="flex items-center justify-center">
                      <!-- Spinner while toggling -->
                      <div
                        x-show="r._toggling"
                        class="flex items-center justify-center h-4"
                      >
                        <svg
                          class="animate-spin text-indigo-600 w-4 h-4"
                          xmlns="http://www.w3.org/2000/svg"
                          viewBox="0 0 24 24"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="2"
                          ></circle>
                          <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                          ></path>
                        </svg>
                      </div>

                      <!-- Checkbox + label (when controls enabled and not toggling) -->
                      <label
                        x-show="!r._toggling && controlsEnabled"
                        class="flex items-center space-x-3 px-2"
                      >
                        <input
                          type="checkbox"
                          :checked="r.attended"
                          @change="onToggleRow(r)"
                          :disabled="!(controlsEnabled && (r.registration_id || (r.source === 'attendance' && r.attended)))"
                          style="accent-color: #16a34a"
                          :title="r.registration_id ? 'Confirmar/Desconfirmar preregistro' : (r.source === 'attendance' ? 'Desmarcar asistencia registrada' : 'Solo asistencia registrada (sin preregistro)')"
                        />
                        <span
                          class="text-sm text-gray-700"
                          x-text="r.attended ? 'Sí' : 'No'"
                        ></span>
                      </label>

                      <!-- When controls are disabled, show either a clock (when still accepting confirmations)
                           or the definitive attendance indicator when the registration window is closed. -->
                      <div
                        x-show="!controlsEnabled && !r._toggling"
                        class="flex items-center justify-center px-2"
                      >
                        <!-- If the activity has closed its registration window, display check for attended, X for not attended -->
                        <i
                          x-show="registerState === 'closed' && r.attended"
                          class="ti ti-check text-green-600"
                          title="Asistió"
                          aria-hidden="true"
                        ></i>
                        <i
                          x-show="registerState === 'closed' && !r.attended"
                          class="ti ti-x text-red-600"
                          title="No asistió"
                          aria-hidden="true"
                        ></i>

                        <!-- Otherwise (registration still open or pending), show the waiting clock icon -->
                        <i
                          x-show="registerState !== 'closed'"
                          class="ti ti-clock text-gray-400"
                          title="En espera de registro"
                          aria-hidden="true"
                        ></i>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <template x-if="total > per_page">
            <span
              >Página <strong x-text="page"></strong> de
              <strong x-text="Math.ceil(total / per_page) || 1"></strong>,
              mostrando
              <strong x-text="Math.min(regs.length, per_page)"></strong> de
              <strong x-text="total"></strong> registros.</span
            >
          </template>
          <template x-if="total > 0 && total <= per_page">
            <span
              ><strong x-text="total"></strong>
              <span x-text="total === 1 ? 'registro' : 'registros'"></span
            ></span>
          </template>
          <template x-if="total === 0">
            <span>Sin resultados</span>
          </template>
        </div>
        <div x-show="total > per_page" class="flex items-center space-x-2">
          <button
            @click="prevPage()"
            :disabled="page === 1"
            :class="{ 'opacity-50 cursor-not-allowed': page === 1 }"
            class="px-2 py-1 border rounded hover:bg-gray-100 transition-colors disabled:hover:bg-transparent flex items-center"
            title="Página anterior"
          >
            <i class="ti ti-chevron-left"></i>
            <span class="hidden sm:inline ml-1">Anterior</span>
          </button>
          <button
            @click="nextPage()"
            :disabled="page >= Math.ceil(total / per_page)"
            :class="{ 'opacity-50 cursor-not-allowed': page >= Math.ceil(total / per_page) }"
            class="px-2 py-1 border rounded hover:bg-gray-100 transition-colors disabled:hover:bg-transparent flex items-center"
            title="Página siguiente"
          >
            <span class="hidden sm:inline mr-1">Siguiente</span>
            <i class="ti ti-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Walk-in modal -->
    <div
      x-show="showWalkin"
      x-cloak
      class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50"
    >
      <div class="bg-white p-4 rounded w-full max-w-md">
        <h3 class="text-lg font-bold mb-3">Registrar Walk-in</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm mb-1">Número de control</label>
            <div class="flex items-stretch">
              <input
                x-model="walkin.control_number"
                @keydown.enter.prevent="lookupWalkin()"
                class="flex-1 border rounded-l px-3 py-2 h-10"
                placeholder="Número de control"
              />
              <button
                @click="lookupWalkin()"
                class="bg-gray-200 text-gray-800 px-4 rounded-r h-10 hover:bg-gray-300 flex items-center justify-center"
                :disabled="walkinLookupState === 'searching'"
                title="Buscar"
              >
                <i
                  class="ti ti-search"
                  aria-hidden="true"
                  x-show="walkinLookupState !== 'searching'"
                ></i>
                <svg
                  x-show="walkinLookupState === 'searching'"
                  class="animate-spin w-4 h-4 text-gray-700"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 24 24"
                  fill="none"
                  aria-hidden="true"
                >
                  <circle
                    class="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    stroke-width="2"
                  ></circle>
                  <path
                    class="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"
                  ></path>
                </svg>
                <span class="sr-only">Buscar</span>
              </button>
            </div>
          </div>

          <div x-show="walkinLookupState !== 'idle'">
            <label class="block text-sm mb-1">Nombre completo</label>
            <div
              class="w-full border rounded px-3 py-2 bg-gray-50 flex items-center justify-between"
            >
              <span class="text-gray-800" x-text="walkin.full_name || '—'"
                >—</span
              >
              <div class="ml-2 flex-shrink-0">
                <i
                  x-show="walkinFoundSource === 'local'"
                  class="ti ti-user-check text-green-600"
                  title="Encontrado localmente"
                ></i>
                <i
                  x-show="walkinFoundSource === 'external'"
                  class="ti ti-cloud-check text-blue-600"
                  title="Encontrado externamente"
                ></i>
              </div>
            </div>
          </div>

          <div x-show="walkinLookupState === 'found'">
            <label class="block text-sm mb-1">Carrera</label>
            <div class="w-full border rounded px-3 py-2 bg-gray-50">
              <span x-text="walkin.career || '-'">-</span>
            </div>
          </div>

          <div class="flex justify-end items-center space-x-2">
            <button
              @click="doWalkin()"
              :disabled="walkinLookupState !== 'found'"
              class="bg-indigo-600 text-white px-3 py-2 rounded disabled:opacity-50"
            >
              Registrar
            </button>
            <button @click="closeWalkin()" class="px-3 py-2 border rounded">
              Cancelar
            </button>
          </div>

          <div
            x-show="walkinLookupState === 'not_found'"
            class="text-sm text-gray-500"
          >
            Estudiante no encontrado. Verifique el número de control o contacte
            al administrador.
          </div>
          <div
            x-show="walkinLookupState === 'error'"
            class="text-sm text-red-500"
          >
            Error consultando servicio externo. Intente de nuevo.
          </div>
        </div>
      </div>
    </div>

    <!-- Confirm delete modal (solo uno, con estilo mejorado) -->
    <div
      x-show="showConfirmDelete"
      x-cloak
      class="fixed inset-0 flex items-center justify-center z-50"
    >
      <div
        class="absolute inset-0 bg-gradient-to-br from-black/40 to-black/60 backdrop-blur-sm"
      ></div>
      <div
        class="relative bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden"
      >
        <div
          class="flex items-center space-x-3 px-4 py-3 bg-red-600 text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M12 9v4m0 4h.01M4.293 19.707A1 1 0 004 20h16a1 1 0 00.707-1.707L13.414 8.586a2 2 0 00-2.828 0L4.293 19.707z"
            />
          </svg>
          <div class="text-lg font-semibold">Eliminar asistencia</div>
        </div>
        <div class="p-4">
          <div class="mb-4 text-sm text-gray-700">
            ¿Desea eliminar la asistencia de
            <strong
              x-text="deleteCandidate ? deleteCandidate.student_name : ''"
            ></strong
            >?
            <div class="text-xs text-gray-500 mt-2">
              Se podrá deshacer durante
              <span x-text="Math.ceil(undoDuration/1000)"></span> segundos.
            </div>
          </div>
          <div class="flex justify-end space-x-2">
            <button
              @click="cancelDeleteModal()"
              class="px-3 py-2 border rounded"
            >
              Cancelar
            </button>
            <button
              @click="confirmDeleteInModal()"
              class="flex items-center bg-red-600 text-white px-3 py-2 rounded"
            >
              <i class="ti ti-trash h-4 w-4 mr-2" aria-hidden="true"></i>
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Undo toast -->
    <div x-show="undoVisible" x-cloak class="fixed bottom-6 right-6 z-50">
      <div
        class="bg-amber-600 text-white px-4 py-3 rounded shadow-lg flex items-center space-x-3"
        role="status"
        aria-live="polite"
      >
        <div class="flex items-center space-x-3">
          <i class="ti ti-clock text-amber-100"></i>
          <div>
            <div class="text-sm font-medium">Asistencia eliminada</div>
            <div class="text-xs text-amber-100">
              Se eliminará en
              <span x-text="Math.ceil(undoRemaining/1000)"></span>s
            </div>
          </div>
        </div>
        <div class="ml-4">
          <button
            @click="undoDelete()"
            class="bg-white text-amber-700 px-3 py-1 rounded inline-flex items-center"
          >
            <i class="ti ti-arrow-back-up text-amber-700 mr-2"></i>
            Deshacer
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %} {% endblock %} {% block scripts %}
<script>
  window.__registrationsPublic_init = (el) => {
    try {
      return {
        activityId: el.getAttribute("data-activity-id") || "",
        name: el.getAttribute("data-activity-name") || "",
        type: el.getAttribute("data-activity-type") || "",
        deadline: el.getAttribute("data-activity-deadline") || "",
        start: el.getAttribute("data-activity-start") || "",
        end: el.getAttribute("data-activity-end") || "",
        location: el.getAttribute("data-activity-location") || "",
        modality: el.getAttribute("data-activity-modality") || "",
        eventName: el.getAttribute("data-event-name") || "",
        eventSlug: el.getAttribute("data-event-slug") || "",
      };
    } catch (e) {
      console.error("Error initializing registration public data", e);
      return { name: "", type: "", deadline: "" };
    }
  };
</script>
<script src="{{ url_for('static', filename='js/public/registrations_public.js') }}"></script>
{% endblock %}
